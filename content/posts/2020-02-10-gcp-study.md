---
title: "Gcp Study"
date: 2020-02-20T11:39:16+08:00
draft: false
tags: 
categories: 
featured_image: 
description: 
---
# 问题
*场景1*   
用户 在客户端A上传了数据到`数据处理服务X`，并对数据进行了处理，得到`处理结果`  
用户 在客户端B上能够获取`数据处理服务X`的`处理结果`  
( `数据处理服务X` 对于此用户来说是透明的 )   

# 名词解释

*API表面(API surface)*   
API的公共接口 。API surface 包含各种方法，以及这些方法中使用的参数和返回类型。   

*Service Management*   
Google Cloud 基础架构服务， 创建并管理API和服务。  

*Extensible Service Proxy(ESP)*    
基于NGINX的服务代理，类似Isto Service Mesh方式。  

# Cloud endpoints 架构
![endpoint-introduce](https://cloud.google.com/endpoints/docs/images/endpoints-architecture.png?hl=zh-cn)   

供给侧：

1. 配置endpoints: 在OpenAPI配置文件中描述API Surface并配置Endpoints功能（例如API密钥或者身份验证规则)  
2. 部署endpoints配置: 定义的API后，使用 `Cloud SDK` 将其部署到Service Managerment.  
3. 部署API后端： 将ESP和API后端部署到受支持的Google Cloud后端，例如Compoute Engine。ESP会与Endpoints后端服务协同运作，以在运行时保护和监控您的API。   


![Endpoints auchitect](https://cloud.google.com/endpoints/docs/images/endpoints_arch.png?hl=zh-cn)   

组件： 

- ESP 
- Service Control 
- Cloud SDK
- Google Cloud Console 

![K8S ESP](https://cloud.google.com/endpoints/docs/images/endpoints_kube.png?hl=zh-cn)

这张图更清晰了给出endpoints的架构   


# Identity and security 

## Authentication 

- API key  
  Identifies your project using a simple API key to check quota(限额） and access 
- OAuth Client ID   
  requests user consent(同意） so your app can acces the user's data 
- Service account 
  Enables server-to-server, app-level authentication using robot account 

GCP API 使用OAuth 2.0 协议进行用户账号和服务账号的身份验证。 OAuth2.0身份验证过程确定`主账号`和应用  

- 用户账号 作为 `Google账号`进行管理   
- 服务账号 由Cloud IAM管理， 代表非人类用户。  
    

哪种适合 [ Authentication strategies ](https://cloud.google.com/docs/authentication#authentication_strategies)  

## 实践 

[Cloud EndPoints 快速入门](https://cloud.google.com/endpoints/docs/quickstart-endpoints) 实践文档。   
[点击查看示例仓库地址](https://github.com/GoogleCloudPlatform/endpoints-quickstart) 

心得

- 当增加API密钥和限流的功能时，不需要更改后端服务任何代码  
- API的监控通过Google Cloud Console来查看，非常方便。  


# 分析
针对场景一  

1. 客户端有自己的业务后台服务，客户端A的业务后台服务A，简称”后台A“， 客户端B则简称”后台B“， 那么后台A、B访问`数据处理服务X`属于server-to-server的方式来进行身份认证的。  
  - 给后台A创建Service-Account A, 并授予`数据处理服务X`的资源创建、计算、查看角色  
  - 给后台B创建Service-Account B, 并授予`数据处理服务X`的资源查看、计算角色   
  - ~~问题是 两个service-account之间资源理应是隔离的, 没办法解决同一用户获得数据的问题。~~  
  - 在Console中将Service-Account B添加到后台A，并赋予查看、计算角色  
  S3服务又是怎么做到这种资源共享的。  
  [访问跨项目BigQuery数据集](https://cloud.google.com/dataprep/docs/concepts/cross-bq-datasets)   

2. 客户端没有自己的业务后台服务  

# 参考 

1. Cloud EndPoints 简介   
  https://cloud.google.com/endpoints/docs/openapi/about-cloud-endpoints?hl=zh-cn   

2. Cloud Endpoints 架构概览   
  https://cloud.google.com/endpoints/docs/images/endpoints_arch.png?hl=zh-cn    



<br>

<center>  ·End·  </center>
