<!doctype html><html lang=zh class=no-js>
<head>
<meta charset=utf-8>
<meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no">
<meta name=generator content="Hugo 0.91.2"><link rel=canonical type=text/html href=https://hyvi.github.io/docs/golang/>
<meta name=ROBOTS content="NOINDEX, NOFOLLOW">
<link rel="shortcut icon" href=/favicons/favicon.ico>
<link rel=apple-touch-icon href=/favicons/apple-touch-icon-180x180.png sizes=180x180>
<link rel=icon type=image/png href=/favicons/favicon-16x16.png sizes=16x16>
<link rel=icon type=image/png href=/favicons/favicon-32x32.png sizes=32x32>
<link rel=icon type=image/png href=/favicons/android-36x36.png sizes=36x36>
<link rel=icon type=image/png href=/favicons/android-48x48.png sizes=48x48>
<link rel=icon type=image/png href=/favicons/android-72x72.png sizes=72x72>
<link rel=icon type=image/png href=/favicons/android-96x96.png sizes=96x96>
<link rel=icon type=image/png href=/favicons/android-144x144.png sizes=144x144>
<link rel=icon type=image/png href=/favicons/android-192x192.png sizes=192x192>
<title>Golang | Elon`s Blog</title>
<meta name=description content="Elon blog site"><meta property="og:title" content="Golang">
<meta property="og:description" content="用于梳理 golang 相关的笔记
">
<meta property="og:type" content="website">
<meta property="og:url" content="https://hyvi.github.io/docs/golang/"><meta property="og:site_name" content="Elon`s Blog">
<meta itemprop=name content="Golang">
<meta itemprop=description content="用于梳理 golang 相关的笔记
"><meta name=twitter:card content="summary">
<meta name=twitter:title content="Golang">
<meta name=twitter:description content="用于梳理 golang 相关的笔记
">
<link rel=preload href=/scss/main.min.f37c3fb6f746e6bc4c5eba11e2f176c897da8bb403ddc2aaac1d527737818c66.css as=style>
<link href=/scss/main.min.f37c3fb6f746e6bc4c5eba11e2f176c897da8bb403ddc2aaac1d527737818c66.css rel=stylesheet integrity>
<script src=https://code.jquery.com/jquery-3.5.1.min.js integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin=anonymous></script>
<script src=https://unpkg.com/lunr@2.3.8/lunr.min.js integrity=sha384-vRQ9bDyE0Wnu+lMfm57BlYLO0/XauFuKpVsZPs7KEDwYKktWi5+Kz3MP8++DFlRY crossorigin=anonymous></script>
</head>
<body class=td-section>
<header>
<nav class="js-navbar-scroll navbar navbar-expand navbar-dark flex-column flex-md-row td-navbar">
<a class=navbar-brand href=/>
<span class=navbar-logo><svg id="Layer_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 500 500" style="enable-background:new 0 0 500 500"><g><path style="fill:#fff" d="M116.8525 421.9722c-5.7041.0-10.3442-4.3127-10.3442-9.6129V88.183c0-5.3002 4.6401-9.6117 10.3442-9.6117H320.858c3.0347.0 9.3959.5498 11.7506 2.6302l.3545.3442 58.905 63.2912c2.3101 2.491 2.9202 8.4928 2.9202 11.3184v256.2039c0 5.3002-4.6407 9.6129-10.3436 9.6129H116.8525z"/><g><g><g><path style="fill:#767676" d="M384.4445 423.2066H116.852c-6.3839.0-11.5786-4.8658-11.5786-10.8474V88.1831c0-5.9804 5.1947-10.8461 11.5786-10.8461h204.0062c.377.0 9.2786.0329 12.568 2.9389l.3947.3833 58.9508 63.337c3.2135 3.4652 3.2514 11.7924 3.2514 12.1593v256.2036C396.0231 418.3408 390.8284 423.2066 384.4445 423.2066zM116.5079 411.9189c.0848.0278.1999.0531.3441.0531h267.5925c.1442.0.2581-.0253.3441-.0531V156.1556c-.0076-.9033-.3593-3.7347-.7034-5.0037l-57.6527-61.9416c-1.4651-.3176-4.4533-.6389-5.5742-.6389H116.852c-.143.0-.2594.024-.3441.0531V411.9189zm267.4533-261.149zM327.0321 89.371v.0013V89.371z"/></g></g></g><g><g><path style="fill:#5b7fc0" d="M189.0874 210.1754l.0012-.0012c7.7751.0012 15.0295 4.1862 18.932 10.9234 1.9177 3.3159 2.9305 7.1011 2.9293 10.9378.0 5.8394-2.2733 11.3304-6.4032 15.4604-4.1288 4.1288-9.6186 6.4032-15.458 6.4032s-11.328-2.2733-15.458-6.4032-6.4032-9.6186-6.4056-15.4628c.0012-6.025 2.454-11.4897 6.4116-15.4473C177.5953 212.627 183.0601 210.1742 189.0874 210.1754zm7.993 21.8576c.0012-1.4042-.3687-2.7868-1.063-3.9887-1.4293-2.4684-4.0833-3.9995-6.9299-4.0019-4.4077.0024-7.993 3.5877-7.993 7.993.0 2.1356.832 4.1431 2.3427 5.6539 1.5083 1.5083 3.5159 2.3403 5.6503 2.3415 2.1356.0 4.1443-.8308 5.6539-2.3403S197.0816 234.1722 197.0804 232.033z"/><path style="opacity:.3;fill:#fff" d="M189.0898 210.176c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3136 2.9377 7.0988 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8066-21.8612-21.8613.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 212.6276 183.0612 210.176 189.0898 210.176zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 236.239 197.0839 234.2399 197.0839 232.0372z"/><g><defs><path id="SVGID_1_" d="M194.7376 237.6875c-1.4461 1.4461-3.4452 2.3439-5.6479 2.3439-4.4077-.0024-7.9918-3.5865-7.9942-7.9942.0024-4.4125 3.5937-7.999 7.9942-7.9942 2.8443.0 5.497 1.5323 6.924 3.9983.6991 1.2067 1.0702 2.5881 1.0702 3.9959C197.0839 234.2399 196.1861 236.239 194.7376 237.6875z"/></defs><clipPath id="SVGID_2_"><use xlink:href="#SVGID_1_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_2_);fill:#fff" d="M190.0704 225.0237c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9546.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.663-2.8588-6.116.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C193.7885 225.7247 191.9774 225.0237 190.0704 225.0237z"/><path style="opacity:.13;clip-path:url(#SVGID_2_);fill:#020202" d="M190.0704 225.0237c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9546.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.663-2.8588-6.116.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C193.7885 225.7247 191.9774 225.0237 190.0704 225.0237z"/></g><g><defs><path id="SVGID_3_" d="M189.0898 210.176c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3136 2.9377 7.0988 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8066-21.8612-21.8613.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 212.6276 183.0612 210.176 189.0898 210.176zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 236.239 197.0839 234.2399 197.0839 232.0372z"/></defs><clipPath id="SVGID_4_"><use xlink:href="#SVGID_3_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_4_);fill:#5b7fc0" d="M172.6595 215.6045c-3.96 3.96-6.4116 9.4235-6.4116 15.452-.0024 12.0547 9.8066 21.8636 21.8613 21.8612 12.0547.0024 21.8636-9.797 21.8613-21.8612.0024-3.8475-1.0151-7.6326-2.9353-10.9462-3.8977-6.7324-11.1497-10.9151-18.926-10.9151C182.0806 209.1953 176.6171 211.647 172.6595 215.6045z"/></g></g><rect x="198.8952" y="225.1043" style="fill:#5b7fc0" width="122.6266" height="13.8671"/></g><g><path style="fill:#d95140" d="M189.0874 155.7611l.0012-.0012c7.7751.0012 15.0295 4.1862 18.932 10.9234 1.9177 3.3159 2.9305 7.1011 2.9293 10.9378.0 5.8394-2.2733 11.3304-6.4032 15.4604-4.1288 4.1288-9.6186 6.4032-15.458 6.4032s-11.328-2.2733-15.458-6.4032-6.4032-9.6186-6.4056-15.4628c.0012-6.0249 2.454-11.4897 6.4116-15.4473C177.5953 158.2128 183.0601 155.7599 189.0874 155.7611zm7.993 21.8577c.0012-1.4042-.3687-2.7868-1.063-3.9887-1.4293-2.4684-4.0833-3.9995-6.9299-4.0019-4.4077.0024-7.993 3.5877-7.993 7.993.0 2.1356.832 4.1431 2.3427 5.6539 1.5083 1.5083 3.5159 2.3403 5.6503 2.3415 2.1356.0 4.1443-.8308 5.6539-2.3403C196.2508 181.7667 197.0816 179.758 197.0804 177.6188z"/><path style="opacity:.3;fill:#fff" d="M189.0898 155.7617c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3135 2.9377 7.0987 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8066-21.8612-21.8613.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 158.2134 183.0612 155.7617 189.0898 155.7617zm7.9941 21.8613c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 181.8248 197.0839 179.8256 197.0839 177.623z"/><g><defs><path id="SVGID_5_" d="M194.7376 183.2733c-1.4461 1.4461-3.4452 2.3439-5.6479 2.3439-4.4077-.0024-7.9918-3.5865-7.9942-7.9942.0024-4.4125 3.5937-7.9989 7.9942-7.9942 2.8443.0 5.497 1.5323 6.924 3.9983.6991 1.2067 1.0702 2.5881 1.0702 3.9959C197.0839 179.8256 196.1861 181.8248 194.7376 183.2733z"/></defs><clipPath id="SVGID_6_"><use xlink:href="#SVGID_5_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_6_);fill:#fff" d="M190.0704 170.6095c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9546.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.663-2.8588-6.116.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C193.7885 171.3104 191.9774 170.6095 190.0704 170.6095z"/><path style="opacity:.13;clip-path:url(#SVGID_6_);fill:#020202" d="M190.0704 170.6095c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9546.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.663-2.8588-6.116.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C193.7885 171.3104 191.9774 170.6095 190.0704 170.6095z"/></g><g><defs><path id="SVGID_7_" d="M189.0898 155.7617c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3135 2.9377 7.0987 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8066-21.8612-21.8613.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 158.2134 183.0612 155.7617 189.0898 155.7617zm7.9941 21.8613c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 181.8248 197.0839 179.8256 197.0839 177.623z"/></defs><clipPath id="SVGID_8_"><use xlink:href="#SVGID_7_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_8_);fill:#d95140" d="M172.6595 161.1903c-3.96 3.96-6.4116 9.4235-6.4116 15.452-.0024 12.0547 9.8066 21.8636 21.8613 21.8613 12.0547.0024 21.8636-9.797 21.8613-21.8613.0024-3.8474-1.0151-7.6326-2.9353-10.9462-3.8977-6.7324-11.1497-10.9151-18.926-10.9151C182.0806 154.7811 176.6171 157.2327 172.6595 161.1903z"/></g><rect x="198.8952" y="170.69" style="fill:#d95140" width="122.6266" height="13.8671"/></g><g><g><path style="fill:#56a55c" d="M189.5379 264.6147l.0012-.0012c7.7751.0012 15.0294 4.1862 18.932 10.9235 1.9177 3.3159 2.9305 7.1011 2.9293 10.9378.0 5.8394-2.2733 11.3304-6.4032 15.4604-4.1288 4.1288-9.6186 6.4032-15.458 6.4032-5.8394.0-11.3281-2.2733-15.458-6.4032-4.13-4.13-6.4032-9.6186-6.4056-15.4628.0012-6.0249 2.454-11.4897 6.4116-15.4472C178.0458 267.0663 183.5105 264.6135 189.5379 264.6147zm7.993 21.8576c.0012-1.4042-.3687-2.7868-1.063-3.9887-1.4293-2.4684-4.0833-3.9995-6.9299-4.0019-4.4077.0024-7.993 3.5877-7.993 7.993.0 2.1356.832 4.1431 2.3427 5.6538 1.5083 1.5083 3.5159 2.3403 5.6503 2.3415 2.1356.0 4.1443-.8308 5.6539-2.3403C196.7013 290.6202 197.5321 288.6115 197.5309 286.4723z"/><path style="opacity:.3;fill:#fff" d="M189.5403 264.6153c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3135 2.9377 7.0987 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8065-21.8612-21.8613.0-6.0285 2.4516-11.492 6.4116-15.452C178.0482 267.0669 183.5117 264.6153 189.5403 264.6153zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9941.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.6366 290.6783 197.5344 288.6792 197.5344 286.4765z"/><g><defs><path id="SVGID_9_" d="M195.1881 292.1268c-1.4461 1.4461-3.4452 2.3439-5.6479 2.3439-4.4077-.0024-7.9918-3.5865-7.9942-7.9942.0024-4.4125 3.5937-7.9989 7.9942-7.9941 2.8443.0 5.497 1.5323 6.924 3.9983.6991 1.2067 1.0702 2.5881 1.0702 3.9959C197.5344 288.6792 196.6366 290.6783 195.1881 292.1268z"/></defs><clipPath id="SVGID_10_"><use xlink:href="#SVGID_9_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_10_);fill:#fff" d="M190.5209 279.463c-4.4005-.0048-7.9918 3.5817-7.9942 7.9941.0011 1.9547.7088 3.7452 1.8782 5.1354-1.7446-1.4674-2.8575-3.6631-2.8588-6.1161.0024-4.4125 3.5936-7.999 7.9942-7.9941 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C194.239 280.164 192.4279 279.463 190.5209 279.463z"/><path style="opacity:.13;clip-path:url(#SVGID_10_);fill:#020202" d="M190.5209 279.463c-4.4005-.0048-7.9918 3.5817-7.9942 7.9941.0011 1.9547.7088 3.7452 1.8782 5.1354-1.7446-1.4674-2.8575-3.6631-2.8588-6.1161.0024-4.4125 3.5936-7.999 7.9942-7.9941 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C194.239 280.164 192.4279 279.463 190.5209 279.463z"/></g><g><defs><path id="SVGID_11_" d="M189.5403 264.6153c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3135 2.9377 7.0987 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8065-21.8612-21.8613.0-6.0285 2.4516-11.492 6.4116-15.452C178.0482 267.0669 183.5117 264.6153 189.5403 264.6153zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9941.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.6366 290.6783 197.5344 288.6792 197.5344 286.4765z"/></defs><clipPath id="SVGID_12_"><use xlink:href="#SVGID_11_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_12_);fill:#56a55c" d="M173.11 270.0439c-3.96 3.96-6.4116 9.4235-6.4116 15.452-.0024 12.0547 9.8066 21.8636 21.8613 21.8613 12.0547.0024 21.8636-9.797 21.8613-21.8613.0024-3.8474-1.0151-7.6326-2.9353-10.9462-3.8977-6.7325-11.1497-10.9151-18.926-10.9151C182.5311 263.6346 177.0676 266.0863 173.11 270.0439z"/></g></g><rect x="199.3456" y="279.5436" style="fill:#56a55c" width="122.6266" height="13.8671"/></g><g><g><path style="fill:#f1bc42" d="M189.0874 318.7208l.0012-.0012c7.7751.0012 15.0295 4.1862 18.932 10.9234 1.9177 3.3159 2.9305 7.1011 2.9293 10.9378.0 5.8394-2.2733 11.3305-6.4032 15.4604-4.1288 4.1288-9.6186 6.4032-15.458 6.4032s-11.328-2.2733-15.458-6.4032-6.4032-9.6186-6.4056-15.4628c.0012-6.025 2.454-11.4897 6.4116-15.4472C177.5953 321.1724 183.0601 318.7196 189.0874 318.7208zm7.993 21.8576c.0012-1.4042-.3687-2.7868-1.063-3.9887-1.4293-2.4684-4.0833-3.9995-6.9299-4.0019-4.4077.0024-7.993 3.5877-7.993 7.993.0 2.1356.832 4.1431 2.3427 5.6539 1.5083 1.5083 3.5159 2.3403 5.6503 2.3415 2.1356.0 4.1443-.8308 5.6539-2.3403S197.0816 342.7176 197.0804 340.5784z"/><path style="opacity:.3;fill:#fff" d="M189.0898 318.7214c7.7763.0 15.0283 4.1826 18.926 10.915 1.9201 3.3136 2.9377 7.0988 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8612-12.0547.0024-21.8636-9.8065-21.8612-21.8612.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 321.173 183.0612 318.7214 189.0898 318.7214zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 344.7844 197.0839 342.7853 197.0839 340.5826z"/><g><defs><path id="SVGID_13_" d="M194.7376 346.2329c-1.4461 1.4461-3.4452 2.3439-5.6479 2.3439-4.4077-.0024-7.9918-3.5865-7.9942-7.9942.0024-4.4125 3.5937-7.999 7.9942-7.9942 2.8443.0 5.497 1.5323 6.924 3.9983.6991 1.2067 1.0702 2.5881 1.0702 3.9959C197.0839 342.7853 196.1861 344.7844 194.7376 346.2329z"/></defs><clipPath id="SVGID_14_"><use xlink:href="#SVGID_13_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_14_);fill:#fff" d="M190.0704 333.5691c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9547.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.6631-2.8588-6.1161.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0834 6.1218 2.8788C193.7885 334.2701 191.9774 333.5691 190.0704 333.5691z"/><path style="opacity:.13;clip-path:url(#SVGID_14_);fill:#020202" d="M190.0704 333.5691c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9547.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.6631-2.8588-6.1161.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0834 6.1218 2.8788C193.7885 334.2701 191.9774 333.5691 190.0704 333.5691z"/></g><g><defs><path id="SVGID_15_" d="M189.0898 318.7214c7.7763.0 15.0283 4.1826 18.926 10.915 1.9201 3.3136 2.9377 7.0988 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8612-12.0547.0024-21.8636-9.8065-21.8612-21.8612.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 321.173 183.0612 318.7214 189.0898 318.7214zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 344.7844 197.0839 342.7853 197.0839 340.5826z"/></defs><clipPath id="SVGID_16_"><use xlink:href="#SVGID_15_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_16_);fill:#f1bc42" d="M172.6595 324.15c-3.96 3.96-6.4116 9.4235-6.4116 15.452-.0024 12.0547 9.8066 21.8636 21.8613 21.8612 12.0547.0024 21.8636-9.797 21.8613-21.8612.0024-3.8474-1.0151-7.6327-2.9353-10.9462-3.8977-6.7324-11.1497-10.9151-18.926-10.9151C182.0806 317.7407 176.6171 320.1924 172.6595 324.15z"/></g></g><rect x="198.8952" y="333.6497" style="fill:#f1bc42" width="122.6266" height="13.8671"/></g></g></svg></span><span class="text-uppercase font-weight-bold">Elon`s Blog</span>
</a>
<div class="td-navbar-nav-scroll ml-md-auto" id=main_navbar>
<ul class="navbar-nav mt-2 mt-lg-0">
<li class="nav-item mr-4 mb-2 mb-lg-0">
<a class="nav-link active" href=/docs/><i class="fas fa-blog"></i><span class=active>Blog</span></a>
</li>
<li class="nav-item mr-4 mb-2 mb-lg-0">
<a class=nav-link href=/tools/><i class="fas fa-tools"></i><span>Tools</span></a>
</li>
<li class="nav-item mr-4 mb-2 mb-lg-0">
<a class=nav-link href=/about/><i class="fas fa-info-circle"></i><span>About</span></a>
</li>
</ul>
</div>
<div class="navbar-nav d-none d-lg-block">
<input type=search class="form-control td-search-input" placeholder="&#xf002; 站内搜索…" aria-label=站内搜索… autocomplete=off data-offline-search-index-json-src=/offline-search-index.162ddd56e30b021e2da4f41d2115d234.json data-offline-search-base-href=/ data-offline-search-max-results=10>
</div>
</nav>
</header>
<div class="container-fluid td-outer">
<div class=td-main>
<div class="row flex-xl-nowrap">
<div class="col-12 col-md-3 col-xl-2 td-sidebar d-print-none">
</div>
<div class="d-none d-xl-block col-xl-2 td-toc d-print-none">
</div>
<main class="col-12 col-md-9 col-xl-8 pl-md-5" role=main>
<div class=td-content>
<div class="pageinfo pageinfo-primary d-print-none">
<p>
这是本节的多页打印视图。
<a href=# onclick="return print(),!1">点击此处打印</a>.
</p><p>
<a href=/docs/golang/>返回本页常规视图</a>.
</p>
</div>
<h1 class=title>Golang</h1>
<div class=lead>用于梳理 golang 相关的笔记</div>
<ul>
<li>1: <a href=#pg-b483bd85453757b9e33563db1772e983>About Golang String</a></li>
<li>2: <a href=#pg-7fba756dfa6d3e0c7ed3a45a87196075>Monorepo for Golang With Bazel</a></li>
<li>3: <a href=#pg-3b83ac5f286d261b4b7ae1b2137d125b>Golang Pprof 使用梳理</a></li>
<li>4: <a href=#pg-f691475805d1a40b7cd3005ba6a3c434>Gorm</a></li>
<li>5: <a href=#pg-762d41fcff5885e1e92c42644dfdb847>Golang语言之禅</a></li>
<li>6: <a href=#pg-7d846e61c330595767c77bde2caf83bc>Code Review 开始</a></li>
<li>7: <a href=#pg-2ba8936b35c18b67399290e83295cff1>Gomonkey Test</a></li>
<li>8: <a href=#pg-90baeac0d8907b563e8b6e698754f11a>Daily 0131 Golang 杂乱</a></li>
</ul>
<div class=content>
</div>
</div>
<div class=td-content>
<h1 id=pg-b483bd85453757b9e33563db1772e983>1 - About Golang String</h1>
<h2 id=问题>问题</h2>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-golang data-lang=golang><span style=color:#204a87;font-weight:700>package</span> <span style=color:#000>main</span>

<span style=color:#204a87;font-weight:700>import</span> <span style=color:#000;font-weight:700>(</span>
	<span style=color:#4e9a06>&#34;fmt&#34;</span>
<span style=color:#000;font-weight:700>)</span>
<span style=color:#204a87;font-weight:700>func</span> <span style=color:#000>main</span><span style=color:#000;font-weight:700>()</span> <span style=color:#000;font-weight:700>{</span>
	<span style=color:#204a87;font-weight:700>var</span> <span style=color:#000>bys</span>  <span style=color:#000;font-weight:700>[</span><span style=color:#0000cf;font-weight:700>20</span><span style=color:#000;font-weight:700>]</span><span style=color:#204a87;font-weight:700>byte</span>

	<span style=color:#000>bys</span><span style=color:#000;font-weight:700>[</span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>]</span> <span style=color:#000;font-weight:700>=</span>  <span style=color:#4e9a06>&#39;h&#39;</span>
	<span style=color:#000>bys</span><span style=color:#000;font-weight:700>[</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>]</span> <span style=color:#000;font-weight:700>=</span>  <span style=color:#4e9a06>&#39;e&#39;</span>
	<span style=color:#000>bys</span><span style=color:#000;font-weight:700>[</span><span style=color:#0000cf;font-weight:700>2</span><span style=color:#000;font-weight:700>]</span> <span style=color:#000;font-weight:700>=</span>  <span style=color:#4e9a06>&#39;i&#39;</span>

	<span style=color:#204a87;font-weight:700>if</span> <span style=color:#204a87>string</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>bys</span><span style=color:#000;font-weight:700>[:])</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#4e9a06>&#34;hei&#34;</span> <span style=color:#000;font-weight:700>{</span>
		<span style=color:#000>fmt</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Println</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#34;[20]byte(&#39;h&#39;,&#39;e&#39;,&#39;i&#39;) === \&#34;hei\&#34;&#34;</span><span style=color:#000;font-weight:700>)</span>
	<span style=color:#000;font-weight:700>}</span>
<span style=color:#000;font-weight:700>}</span>
</code></pre></div><p>输出： [20]byte(&lsquo;h&rsquo;,&lsquo;e&rsquo;,&lsquo;i&rsquo;) === &ldquo;hei&rdquo;</p>
<h2 id=要点>要点</h2>
<ul>
<li>the internal structure of any string type is declared like:</li>
</ul>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-golang data-lang=golang><span style=color:#204a87;font-weight:700>type</span> <span style=color:#000>_string</span> <span style=color:#204a87;font-weight:700>struct</span> <span style=color:#000;font-weight:700>{</span>
   <span style=color:#000>elements</span> <span style=color:#ce5c00;font-weight:700>*</span><span style=color:#204a87;font-weight:700>byte</span> <span style=color:#8f5902;font-style:italic>// underlying bytes
</span><span style=color:#8f5902;font-style:italic></span>   <span style=color:#000>len</span>      <span style=color:#204a87;font-weight:700>int</span>   <span style=color:#8f5902;font-style:italic>// number of bytes
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#000;font-weight:700>}</span>
</code></pre></div><ul>
<li>
<p>String types are all comparable, When comparing two strings, <strong>their underlying bytes will be compared, one byte by one byte.</strong></p>
</li>
<li>
<p>if one string is a prefix of the other one and the other one is longer, then the other one will viewed as the large one.</p>
</li>
<li>
<p>when a byte slice is converted to a string, <strong>the underlying byte sequence of the result string is also just a deep copy of the byte slice</strong>.</p>
</li>
</ul>
<h2 id=延伸>延伸</h2>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-golang data-lang=golang><span style=color:#204a87;font-weight:700>package</span> <span style=color:#000>main</span>

<span style=color:#204a87;font-weight:700>import</span> <span style=color:#000;font-weight:700>(</span>
	<span style=color:#4e9a06>&#34;fmt&#34;</span>
<span style=color:#000;font-weight:700>)</span>

<span style=color:#204a87;font-weight:700>const</span> <span style=color:#000>s</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#4e9a06>&#34;Go101.org&#34;</span>

<span style=color:#8f5902;font-style:italic>// len(s) is a constant expression, 
</span><span style=color:#8f5902;font-style:italic>// whereas len(s[:]) is not.
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>var</span> <span style=color:#000>a</span> <span style=color:#204a87;font-weight:700>byte</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>1</span> <span style=color:#ce5c00;font-weight:700>&lt;&lt;</span> <span style=color:#204a87>len</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>s</span><span style=color:#000;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>/</span> <span style=color:#0000cf;font-weight:700>128</span> 
<span style=color:#204a87;font-weight:700>var</span> <span style=color:#000>b</span> <span style=color:#204a87;font-weight:700>byte</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>1</span> <span style=color:#ce5c00;font-weight:700>&lt;&lt;</span> <span style=color:#204a87>len</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>s</span><span style=color:#000;font-weight:700>[:])</span> <span style=color:#ce5c00;font-weight:700>/</span> <span style=color:#0000cf;font-weight:700>128</span>

<span style=color:#204a87;font-weight:700>func</span> <span style=color:#000>main</span><span style=color:#000;font-weight:700>()</span> <span style=color:#000;font-weight:700>{</span>
	<span style=color:#000>fmt</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Println</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>a</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>b</span><span style=color:#000;font-weight:700>)</span> <span style=color:#8f5902;font-style:italic>// 4 0	
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#000;font-weight:700>}</span>

</code></pre></div><p>为什么会出现不一样的结果，一个要点是： <strong>the special type deduction rule in bitwise shift operator operation</strong></p>
<ul>
<li>
<p>当位运算左元素为 <strong>untyped value</strong>， 并且右元素为 constant 时，运算的结果类型保持与左元素一样。</p>
</li>
<li>
<p>当位运算左元素为 <strong>untyped value</strong>， 并且右元素为 non-constant 时，首先左元素类型转化为 assumed type (it would assume if the bitwise shift operator operation were replaced by its left operand alone)</p>
</li>
</ul>
<p>根据上面两个 rule, 上面语句变成：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-golang data-lang=golang><span style=color:#204a87;font-weight:700>var</span> <span style=color:#000>a</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#204a87>byte</span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87>int</span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>&lt;&lt;</span> <span style=color:#204a87>len</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>s</span><span style=color:#000;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>/</span> <span style=color:#0000cf;font-weight:700>128</span><span style=color:#000;font-weight:700>)</span>
<span style=color:#204a87;font-weight:700>var</span> <span style=color:#000>b</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#204a87>byte</span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>&lt;&lt;</span> <span style=color:#204a87>len</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>s</span><span style=color:#000;font-weight:700>[:])</span> <span style=color:#ce5c00;font-weight:700>/</span> <span style=color:#0000cf;font-weight:700>128</span>
</code></pre></div><p>为什么会有这样的 rule ？</p>
<blockquote>
<p>avoid the cases that some bitwise shift operations retuan different results on different architectures but the differences will not be detected in time.</p>
</blockquote>
<p>举个例子</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-golang data-lang=golang><span style=color:#204a87;font-weight:700>var</span> <span style=color:#000>m</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#204a87>uint</span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>32</span><span style=color:#000;font-weight:700>)</span>
<span style=color:#8f5902;font-style:italic>// The following three lines are equivalent to each other.
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>var</span> <span style=color:#000>x</span> <span style=color:#204a87;font-weight:700>int64</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>1</span> <span style=color:#ce5c00;font-weight:700>&lt;&lt;</span> <span style=color:#000>m</span> 
<span style=color:#204a87;font-weight:700>var</span> <span style=color:#000>y</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#204a87>int64</span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>1</span> <span style=color:#ce5c00;font-weight:700>&lt;&lt;</span> <span style=color:#000>m</span><span style=color:#000;font-weight:700>)</span>
<span style=color:#204a87;font-weight:700>var</span> <span style=color:#000>z</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#204a87>int64</span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>&lt;&lt;</span> <span style=color:#000>m</span>
</code></pre></div><center> ·End· </center>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-7fba756dfa6d3e0c7ed3a45a87196075>2 - Monorepo for Golang With Bazel</h1>
<h2 id=背景>背景</h2>
<blockquote>
<p>ProtocolBuffer + gRPC + Bazel + Monorepo + Microservice is the common poly glot pattern which is also used in Google and other tech companies</p>
</blockquote>
<p>微服务面临的问题是大量的 repo（成百上千）， 尤其在依赖库的管理、规范的落地，非常麻烦困难。</p>
<p>需求点</p>
<ul>
<li>使用同一的 go.mod 来管理依赖</li>
<li>在不同的应用里可以服用共同的代码块</li>
<li>可以执行单个应用的测试也可以执行所有应用的测试</li>
<li>可以构建单个应用或者所有的应用</li>
</ul>
<h2 id=新概念>新概念</h2>
<h3 id=bazel>Bazel</h3>
<blockquote>
<p>Bazel is an open-source build and test tool similar to Make, Maven, and Gradle. It uses a human-readable, high-level build language. Bazel supports projects in multiple languages and builds outputs for multiple platforms. Bazel supports large codebases across multiple repositories, and large numbers of users.</p>
</blockquote>
<h3 id=rule>Rule</h3>
<blockquote>
<p>A rule defines a series of actions that Bazel performs on inputs to produce a set of outputs.</p>
</blockquote>
<p>rule_go 为 golang 编写的 rules。</p>
<p>对 Rule 进一步的了解，学习如何编写 rule，资料入口: rule_go 的作者系列文档： <a href=https://github.com/jayconrod/rules_go_simple>A simple set of Go rules for Bazel, used for learning and experimentation.</a></p>
<h3 id=gazelle>Gazelle</h3>
<blockquote>
<p>Gazelle is a build file generator for Bazel projects. It can create new BUILD.bazel files for a project that follows language conventions, and it can update existing build files to include new sources, dependencies, and options. Gazelle natively supports Go and protobuf,</p>
</blockquote>
<h2 id=实践>实践</h2>
<p>《Create Go Monorepo with Go-modules and Bazel》</p>
<p>Example: <a href=https://github.com/PxyUp/go_monorepo>https://github.com/PxyUp/go_monorepo</a></p>
<h3 id=gazelle-使用>Gazelle 使用</h3>
<pre tabindex=0><code>bazel run //:gazelle
</code></pre><p>疑惑点：</p>
<ul>
<li><input checked disabled type=checkbox> 每个 module 需要写 BUILD.bazel 配置文件，带来额外的麻烦。
<ul>
<li>Gazelle build file generator，原生支持 Go / protobuf</li>
</ul>
</li>
<li>如何跟 reviewdog(golangci-linter) 结合</li>
<li><input checked disabled type=checkbox> <del>不支持 IDE， 给习惯用 IDE 的来说是不愿意的接受</del></li>
<li>如何处理 grpc 生成的代码
<ul>
<li>共享生成的仓库</li>
</ul>
</li>
</ul>
<h2 id=结论>结论</h2>
<ul>
<li>有利于代码共享，解决各自孤立的状态</li>
<li>有利于统一依赖库，统一升级，确保安全。</li>
<li>新的技术，激活技术氛围和兴趣</li>
</ul>
<h2 id=faq>FAQ</h2>
<p>Q: how do you set up a CI/CD pipeline for a mono repo? When a code change to the repository triggers CI</p>
<p>A: <a href=http://blog.shippable.com/ci/cd-of-microservices-using-mono-repos>http://blog.shippable.com/ci/cd-of-microservices-using-mono-repos</a>， 更多内容参考： <a href=https://github.com/korfuri/awesome-monorepo/blob/master/README.md>https://github.com/korfuri/awesome-monorepo/blob/master/README.md</a></p>
<h2 id=参考>参考</h2>
<p><a href=https://github.com/atlassian/bazel-tools>Bazel 结合 golangci-linter</a></p>
<p><a href=https://www.reddit.com/r/golang/comments/dfod3o/guide_create_monorepo_with_go_modules_and_bazel/>Guide: Create monorepo with Go Modules and Bazel</a></p>
<p><a href=https://www.reddit.com/r/golang/comments/gjo2ei/building_ubers_go_monorepo_with_bazel/>Monorepo at Uber</a></p>
<p><a href=https://conan.io/>cmake + Conan：decentralized and multi-platform package manager to create and share all your native binaries.</a></p>
<p><a href=https://hardyantz.medium.com/>Monorepo with bazel and go module： 践行者</a></p>
<br>
<center> ·End· </center>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-3b83ac5f286d261b4b7ae1b2137d125b>3 - Golang Pprof 使用梳理</h1>
<h2 id=背景>背景</h2>
<p>当前碰到的问题：</p>
<ul>
<li>部分服务 CPU 负载比较高</li>
<li>服务内存使用量比较大</li>
<li>服务高延迟（内存 CPU 负载都不高情况）</li>
</ul>
<p>golang 开发中有一些定位这些问题的套路和工具，在本文中汇总，记录并不断改进解决问题的思路。</p>
<p>从两个方面考虑：</p>
<ul>
<li>系统监控统计级别数据指标
<ul>
<li>goroutine 数量</li>
<li>堆 (heap) 内存使用量</li>
<li>栈 (stack) 内存使用量</li>
<li>其他&mldr;（待补充）</li>
</ul>
</li>
<li>问题定位所需的详细数据
<ul>
<li>获取系统实时堆内存分配详细信息：具体到这个内存在哪里分配的。</li>
<li>获取系统实时所有 goroutine 调用堆栈信息：具体到这个 goroutine 是在哪里启动的，以及当前在干什么</li>
<li>获取系统实时堆内存调优辅助统计信息： 具体是在哪里分配了多少内存，以及 TOP N 分别是哪些，甚至是每个内存分配的来源图</li>
</ul>
</li>
</ul>
<h2 id=diagnostics>Diagnostics</h2>
<h3 id=获取系统实时堆内存分配详情>获取系统实时堆内存分配详情</h3>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-golang data-lang=golang><span style=color:#8f5902;font-style:italic>// 引入 pprof
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>import</span> <span style=color:#4e9a06>&#34;net/http/pprof&#34;</span>
<span style=color:#8f5902;font-style:italic>// 在 http router 上加入
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#000>this</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>debugMux</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>HandleFunc</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#34;/debug/pprof/&#34;</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>http</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>HandlerFunc</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>pprof</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Index</span><span style=color:#000;font-weight:700>))</span>
</code></pre></div><p><code>curl -XGET "http://192.168.149.150:8080/debug/pprof/heap?debug=2"</code> 获取 heap 内存的详细信息，其中 8080 是你开启的 http server 的端口，debug=2 意味着需要输出详细信息</p>
<h3 id=获取系统实时所有-goroutine-调用栈信息>获取系统实时所有 goroutine 调用栈信息</h3>
<p>通过<code>curl -XGET "http://192.168.149.150:8080/debug/pprof/goroutine?debug=2"</code>拿到的就是 goroutine 的详细信息</p>
<h3 id=获取系统实时堆内存调优辅助统计信息>获取系统实时堆内存调优辅助统计信息</h3>
<p><code>go tool pprof -inuse_space http://192.168.149.150:8080/debug/pprof/heap</code>，进入 pprof 交互模式后，可以通过 top, tree 等进一步查看统计信息，同时，也可以通过 png 命令，将内存信息输出成图片，以图片的形式显示内存的分配、占用情况</p>
<h3 id=获取-trace-数据>获取 trace 数据</h3>
<p>通过：<code>curl -XGET "http://127.0.0.1:8080/debug/pprof/trace?seconds=30" -o 002_trace_2017_09_08.out</code>我们将获取一个 30 秒的 trace 数据 (trace_02.out)，通过<code>go tool trace 002_trace_2017_09_08.out</code></p>
<p>也是各种坑， 比如页面打开空白： <a href=https://github.com/golang/go/issues/25151>gotip tool trace xxx.out</a></p>
<h3 id=profile>Profile</h3>
<p>侧重于统计程序各 goroutine 自身的运行状况，更加适用于分析针对 cpu 密集型逻辑导致的 latency 过高问题</p>
<h4 id=cpu>cpu</h4>
<h4 id=heap>heap</h4>
<p>pprof 的 top 会列出 5 个统计数据：</p>
<ul>
<li>flat: 本函数占用的内存量</li>
<li>flat%: 本函数内存占使用中内存总量的百分比</li>
<li>sum%: 前面每一行 flat 百分比的和</li>
<li>cum： 是累计量，假如 main 函数调用了函数 f, 函数 f 占用的内存量，也会记进来</li>
<li>cum%: 是累计量占总量的百分比</li>
</ul>
<p>Memory profiling records the stack trace when a heap allocation is made</p>
<p>Stack allocations are assumed to be free and are not tracked in the memory profile.</p>
<p>Memory profiling, like CPU profiling is sample based, by default memory profiling samples 1 in every 1000 allocations this rate can be changed.</p>
<p>Because of memory profiling is samples based and because it tracks allocation not use , using memory profiling to determine your Application&rsquo;s overall memory usage is difficult .</p>
<h5 id=heap-不能-定位内存泄漏>Heap &ldquo;不能&rdquo; 定位内存泄漏</h5>
<p><img src="https://segmentfault.com/img/remote/1460000019222668?w=1008&h=868/view" alt></p>
<ol>
<li>该 goroutine 只调用了少数几次，但是消耗大量的内存</li>
<li>该 goroutine 调用次数非常多，虽然协程调用过程中消耗的内存不多，但该调用路径上，协程数量巨大，造成大量的内存消耗，并且这些 goroutine 由于某种原因无法退出，占用的内存不会释放。</li>
</ol>
<p>第二种情况， 就是<strong>goroutine 泄漏</strong>， 这是通过 heap 无法发现的，所以 heap 在定位内存泄漏这件事情上，发挥作用不大。</p>
<h5 id=goroutine-泄漏怎么导致内存泄漏>goroutine 泄漏怎么导致内存泄漏</h5>
<ul>
<li>每个 goroutine 占用 2kb 内存</li>
<li>goroutine 执行过程中存在一些变量，如果这些变量指向堆中的内存，GC 会认为这些内存仍在使用，不会对其进行回收，这些内存无法使用，造成内存泄漏
a. goroutine 本身的栈占用的空间
b. goroutine 中的变量所占用的堆内存，这一部分是能通过 heap profile 体现出来的。</li>
</ul>
<h5 id=如何定位-goroutine-内存泄漏>如何定位 goroutine 内存泄漏</h5>
<p>pprof 查看当前 heap 里谁（哪一段代码分配）占用内存比较大，
so 正确的做法是导出两个时间点的 heap profile 信息文件，使用 &ndash;base 参数进行对比</p>
<blockquote>
<p>来自 <a href=https://colobu.com/2019/08/20/use-pprof-to-compare-go-memory-usage/>Hi, 使用多年的 go pprof 检查内存泄漏的方法居然是错的？!</a></p>
</blockquote>
<p><a href=https://lessisbetter.site/2019/05/18/go-goroutine-leak/>实战 Go 内存泄漏</a> 通过监控工具和 go pprof 的 diff 方式来定位内存泄漏的问题，非常详细了，定位 goroutine 泄漏的方式</p>
<ul>
<li>
<p>查看某条调用路径上，当前阻塞在此 goroutine 的数量</p>
<ul>
<li><code>go tool pprof http://ip:port/debug/pprof/goroutine?debug=1</code></li>
</ul>
</li>
<li>
<p>查看所有 goroutine 的运行栈，可以显示阻塞在此的时间</p>
<ul>
<li><code>go tool pprof http://ip:port/debug/pprof/goroutine?debug=2</code></li>
</ul>
</li>
</ul>
<p><a href=https://juejin.im/post/5d9ff459f265da5b8a5160f5>goroutine 究竟占了多少内存？</a>, 先来看看结论</p>
<ul>
<li>goroutine 所占用的内存，均在栈中进行管理</li>
<li>goroutine 所占用的栈空间的大小，由 runtime 按需进行分配</li>
<li>以 64 位环境的 JVM 为例，会默认固定为每个线程分配 1M 栈空间，如果大小分配不当，会出现栈溢出的问题</li>
</ul>
<p><a href=https://juejin.im/post/5ce11d1ee51d4510601117fd>我是如何在大型代码库上使用pprof调查 Go 中的内存泄漏</a></p>
<ul>
<li>pprof的工作方式是使用画像。？？？ 画像是一组显示导致特定事件实例的调用顺序堆栈的追踪，例如内存分配.</li>
<li>如果内存消费是已个相关的考虑因素的话， 当数据不稀疏或者可以转换为顺序索引时，使用amp[int]T也没问题，但是通常应该使用切片实现。
<ul>
<li>扩容一个切片时，切片可能会使操作变慢，在map中这种变慢可以忽略不计。</li>
</ul>
</li>
</ul>
<h5 id=go-内存原理>Go 内存原理</h5>
<p>然后来了解内存中的几个概念</p>
<p><strong>分段栈</strong></p>
<p>早起版本中，Go 给 goroutine 分配固定的 8kb 的内存区域，当 8kb 空间不够了怎么办？</p>
<p>GO 会在每个函数入口处插入一小段前置代码，它能够检查栈空间十分被消耗殆尽，如果用完了，会调用 morestack() 函数来扩展空间。</p>
<p>带来的问题： 熟知的 hot split problem （热点分裂问题）</p>
<p><strong>连续栈</strong></p>
<p>从 Go1.4 之后，正式使用连续机制，二倍大小空间进行复制</p>
<p><strong>mem.Sys</strong>: Sys measures the virtual address space reserved by Go runtime for the heap, stacks, and other internal data structures.</p>
<p><strong>mem.Alloc</strong> : 已经被分配并仍在使用的字节数, the same as mem.HeapAlloc</p>
<p><strong>mem.TotalAlloc</strong>: 从开始运行到现在分配的内存总数</p>
<p><strong>mem.HeapAlloc</strong>: 堆当前的用量, 具体如下两个</p>
<ul>
<li>all reachable objects</li>
<li>unreachable objects that the garbage collector has not yet freed</li>
</ul>
<p><strong>mem.HeapSys</strong>: 包含堆当前和已经被释放但尚未归还操作系统的用量, 以及预留的空间.</p>
<p><strong>mem.HeapIdle</strong>:</p>
<p><strong>mem.HeapReleased</strong>:</p>
<p>以上详细解释参考 <a href=https://golang.org/pkg/runtime/#MemStats>runtime#Memstats</a></p>
<p><a href=https://github.com/q191201771/pprofplus>pprofplus</a> 将内存绘制成曲线图来查看内存的变化</p>
<p><a href=https://studygolang.com/articles/610>golang 手动管理内存</a> #TODO 为什么加这个链接?</p>
<h6 id=内存使用分析方法>内存使用分析方法</h6>
<p><a href=https://mikespook.com/2014/12/%E7%90%86%E8%A7%A3-go-%E8%AF%AD%E8%A8%80%E7%9A%84%E5%86%85%E5%AD%98%E4%BD%BF%E7%94%A8/> 理解 go 语言的内存使用 </a> 中三种方式</p>
<ul>
<li>通过 runtime 包的 ReadMemStats 函数
<ul>
<li><a href="https://webcache.googleusercontent.com/search?q=cache:a6taX0NwR4cJ:https://forum.golangbridge.org/t/memory-usage-when-reading-large-files/10432+&cd=3&hl=zh-CN&ct=clnk">Memory Usage when reading large file</a> 提问者读一定大小的文件到内存，而实际上分配的内存远高于文件大小。</li>
</ul>
</li>
<li>通过 pprof 包, pprof 仅仅是获取了样本，而不是真正 的值，是非常重要的？
<ul>
<li><a href=https://groups.google.com/forum/#!topic/golang-nuts/Rhr758e7vo0>tools/techniques for tracking down &ldquo;too many open files&rdquo; </a>: the memory profile shows where the things ware created, not where they &lsquo;live&rsquo;.</li>
</ul>
</li>
<li>通过 gc-trace 调式环境变量</li>
<li>cgo 或者syscall 内存泄漏，怎么办？
<ul>
<li>Also CGO / syscall (eg: malloc / mmap) memory is not tracked by go. <a href=https://stackoverflow.com/questions/24863164/how-to-analyze-golang-memory>How to analyze golang memory</a></li>
<li><a href=https://www.pengrl.com/p/29054/>Go语言使用cgo时的内存管理笔记</a> 如何定位cgo内存泄漏 #TODO</li>
<li><a href=https://povilasv.me/go-memory-management-part-3/>Golang cgo memory</a></li>
</ul>
</li>
</ul>
<p><a href=https://draveness.me/golang/>Go 语言设计与实现</a> 详细从源码分析内存分配原理 #TODO</p>
<h5 id=linux-内存结构>linux 内存结构</h5>
<p>VIRT: 亦虚拟内存，虚拟地址空间大小，是程序映射并可以访问的内存数量, 参考下图对虚拟内存的解释,</p>
<p>RES: 亦常驻内存，进程虚拟空间中已经映射到物理内存的那部分的大小。</p>
<p>SHR: 亦共享内存，进程占用的共享内存大小，比如程序会依赖于很多外部的动态库(.so)。</p>
<p><img src=https://img.orchome.com/group1/M00/00/00/KmCudld5_zmAajUHAABd80xLId0540.png alt></p>
<p><a href=https://www.orchome.com/298>理解 virt res shr 之间的关系 - linux</a></p>
<p>mem: 物理内存</p>
<p>swap: 虚拟内存，即可以把数据存在在硬盘的数据</p>
<p>shared： 共享内存 , 存在物理内存中</p>
<p>buffers: 用于存放要输出到 disk 的数据的</p>
<p>cached: 存放从 disk 上读取的数据</p>
<blockquote>
<p>点击查看图片， 来自 <a href=https://cloud.tencent.com/developer/article/1404071>内存与 I/O 的交换</a>, 详细讲解了 file-backed pages vs anonymous pages.</p>
</blockquote>
<table>
<thead>
<tr>
<th>名称</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>total_mem</td>
<td>物理内存总量</td>
</tr>
<tr>
<td>used_mem</td>
<td>已使用的物理内存量</td>
</tr>
<tr>
<td>free_mem</td>
<td>空闲的物理内存量</td>
</tr>
<tr>
<td>shared_mem</td>
<td>共享内存量</td>
</tr>
<tr>
<td>buffer</td>
<td>buffer 所占的内存量，翻译为缓冲区缓存</td>
</tr>
<tr>
<td>cache</td>
<td>cache 所占内存量，翻译为页面缓存</td>
</tr>
<tr>
<td>real_used</td>
<td>实际使用的内存量</td>
</tr>
<tr>
<td>real_free</td>
<td>实际空闲的内存量</td>
</tr>
<tr>
<td>total_swap</td>
<td>swap 总量</td>
</tr>
<tr>
<td>used_swap</td>
<td>已使用的 swap</td>
</tr>
<tr>
<td>free-swap</td>
<td>空闲的 swap</td>
</tr>
</tbody>
</table>
<pre tabindex=0><code>real_used = used_mem - buffer - cache
real_free = free_mem + buffer + cache
total_mem = used_mem + free_mem
</code></pre><p><a href=https://xuxinkun.github.io/2016/05/16/memory-monitor-with-cgroup/>Docker 容器内存监控 </a></p>
<p><a href=https://github.com/digoal/blog/blob/master/201701/20170111_02.md>Linux cgroup - memory 子系统讲解</a>, 非常全面的介绍的 cgroup 里的内存概念</p>
<p>这里面涉及到多个内存相关概念：</p>
<ul>
<li>tmpfs
<ul>
<li><a href=https://segmentfault.com/a/1190000014737366> tmpfs 详解</a></li>
<li>临时文件系统，驻留在内存中</li>
<li>tmpfs 大小： 只有真正在 tmpfs 存储数据了，才会去占用。</li>
</ul>
</li>
<li>page cache
<ul>
<li><strong>page</strong>: The virtual memory is divided in pages .</li>
<li>Page cache 主要用来作为文件系统上的文件数据的缓存来用，尤其是针对当进程对文件有 read/write 操作的时候。<a href=https://github.com/digoal/blog/blob/master/201701/20170111_02.md>什么是 page cache</a></li>
</ul>
</li>
<li>rss, <a href=https://www.jianshu.com/p/3bab26d25d2e>内存耗用：VSS/RSS/PSS/USS 的介绍</a>
<ul>
<li>anonymous and swap cache, not including tmpfs (shmem), in bytes</li>
</ul>
</li>
<li>anonymous cache
<ul>
<li>先了解匿名映射： 进程使用 malloc 申请内存，或使用 mmap(MAP_ANONYMOUS 的方式）申请的内存</li>
<li>再了解文件映射： 进行使用 mmap 映射文件系统的文件，包括普通文件，也包括临时文件系统 (tmpfs), 另外 Sys v 的 IPC 和 POSIX 的 IPC 也是。</li>
</ul>
</li>
<li>swap cache
<ul>
<li>Swap 机制： 当内存不够的时候，我们可以选择性的将一块磁盘、分区或者一个文件当成交换空间，将内存上一些临时用不到的数据放到交换空间上，以释放内存资源给急用的进程。</li>
<li>Inactive（anon 匿名映射）, 这部分内存能被交换出去的。 需要注意的是，内核也将共享内存作为计数统计进了 Inactive（anon）中去了（是的，共享内存也可以被 Swap）。</li>
</ul>
</li>
</ul>
<pre tabindex=0><code>active_file + inactive_file = cache - size of tmpfs

active_anon + inactive_anon = anonymous memory + file cache for tmpfs + swap cache
</code></pre><p><a href=https://techtalk.intersec.com/2013/07/memory-part-1-memory-types/>Memory - Part 1: Memory Types</a></p>
<p>按照两个维度来划分内存</p>
<ul>
<li>whether memory is private ( specific to that process ) or shared
<ul>
<li>private</li>
<li>shared</li>
</ul>
</li>
<li>whether the memory is file-backed or not (in which case it is said the be anonymous )
<ul>
<li><strong>anonymous</strong>: purely in RAM</li>
<li><strong>file-backed</strong>: When a memory map is file-backed, the data is loaded from disk</li>
</ul>
</li>
</ul>
<p>见下表：</p>
<table>
<thead>
<tr>
<th></th>
<th>PRIVATE</th>
<th>SHARED</th>
</tr>
</thead>
<tbody>
<tr>
<td>ANONYMOUS</td>
<td>stack, malloc(),<br> mmap(ANON, PRIVATE), <br>brk()/sbrk()</td>
<td>mmap(ANON, SHARED)</td>
</tr>
<tr>
<td>FILE-BACKED</td>
<td>nmap(fd, PRIVATE) <br> binary/shared libraries</td>
<td>mmapn(fd, SHARED)</td>
</tr>
</tbody>
</table>
<p><a href=https://segmentfault.com/a/1190000022472459>采坑记 - go 服务内存暴涨</a> , 对 MADV_FREE 结合页表来分析，更加详细</p>
<p>内存分配</p>
<ul>
<li>在 Linux 下，malloc 需要在其管理的内存不够用时，调用 brk 或 mmap 系统调用 ( syscall ) 找内核扩充其可用地址空间</li>
<li>OS 用页表来管理进程的地址空间，其中记录了页的状态、对应的物理页地址等信息，一页通常是 4kb</li>
<li>当进程读 / 写尚未分配的页面时，会出发一个缺页中断 ( page fault ), 这时内核才会分配页面，在页表中标记为已分配，然后再恢复进程的执行。</li>
</ul>
<p>内存回收</p>
<ul>
<li>当 free 觉得有必要的时候，会调用 sbrk 或 munmap 缩小地址空间，这是针对一整段地址空间都空出来的情况</li>
<li>但更多的时候只释放其中一部分内容（比如连续的 ABCDE 五个页面中只释放 C 和 D）， 并不需要（也不能）把地址空间缩小</li>
<li>free 可以通过 madvise 告诉内存”这一段我不用了"</li>
</ul>
<p>madvise</p>
<ul>
<li>通过 madvise(addr, length, advise) 这个系统调用，告诉内核可以如何处理从 addr 开始的 length 字节。</li>
<li>在 Linux Kernel 4.5 之前， 只支持 MADV_DONTNEED，内核会在进程的页表中将页标记为"未分配”， 从而进程的 RSS 就会变小。</li>
</ul>
<p>go 1.12 的改进</p>
<ul>
<li>从 kernel 4.5 开始，Linux 支持了 MADV_FREE.</li>
</ul>
<h4 id=threadcreate>threadcreate</h4>
<h4 id=goroutine>goroutine</h4>
<h4 id=block>block</h4>
<h4 id=mutex>mutex</h4>
<p>实践 web 方式 <a href=https://rakyll.org/mutexprofile/>Mutex profle</a></p>
<p><del>里面提到的 PPT 在本地分析不出数据，</del>, 因为没有用 goroutine</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-golang data-lang=golang><span style=color:#204a87;font-weight:700>for</span> <span style=color:#000>_</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>f</span> <span style=color:#ce5c00;font-weight:700>:=</span> <span style=color:#204a87;font-weight:700>range</span> <span style=color:#000>factors</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>n</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{</span>
  <span style=color:#000>mu</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Lock</span><span style=color:#000;font-weight:700>()</span>
  <span style=color:#000>m</span><span style=color:#000;font-weight:700>[</span><span style=color:#000>f</span><span style=color:#000;font-weight:700>]</span><span style=color:#ce5c00;font-weight:700>++</span>
  <span style=color:#000>mu</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Unlock</span><span style=color:#000;font-weight:700>()</span>
<span style=color:#000;font-weight:700>}</span>
</code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-golang data-lang=golang><span style=color:#000>mu</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Lock</span><span style=color:#000;font-weight:700>()</span>
<span style=color:#204a87;font-weight:700>for</span> <span style=color:#000>_</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>f</span> <span style=color:#ce5c00;font-weight:700>:=</span> <span style=color:#204a87;font-weight:700>range</span> <span style=color:#000>factors</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>n</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{</span>
  <span style=color:#000>m</span><span style=color:#000;font-weight:700>[</span><span style=color:#000>f</span><span style=color:#000;font-weight:700>]</span><span style=color:#ce5c00;font-weight:700>++</span>
<span style=color:#000;font-weight:700>}</span>
<span style=color:#000>mu</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Unlock</span><span style=color:#000;font-weight:700>()</span>
</code></pre></div><h3 id=trace>Trace</h3>
<h4 id=synchronization-blocking-profile>Synchronization blocking profile</h4>
<p>来自 rhys Hiltner 分析。</p>
<p>the thing that we are spending here is seconds that we&rsquo;re spent waiting. we have kind of the goroutine name at the top of the stack.</p>
<p>关于方框中"of"前面的的 0, 表示 &ldquo;zero time was spent inside of the box of 4.43. 来自 <a href="https://www.youtube.com/watch?v=N3PWzBeLX2M">Profiling and Optimizing Go, 关于 Type:CPU 的图解，时间： 11:00</a></p>
<h4 id=goroutines>goroutines</h4>
<p>goroutines that were running in that propram during those few seconds that i was recoording and listed.</p>
<p>根据 Execution time\Network wait time\Sync block time\Blocking syscall time\Sechedule wait time 的情况后，可以通过 graph 图了解 goroutine 详细情况。<code>参考 [10]</code></p>
<h3 id=flame>Flame</h3>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>pprof -http <span style=color:#4e9a06>&#34;localhost:12345&#34;</span> <span style=color:#4e9a06>&#39;http://127.0.0.1:53668/block?id=19105152&amp;raw=1&#39;</span>
</code></pre></div><p>查看 goroutine 中执行时间。</p>
<p>在参考 [7] 的视频 11:43 开始实际操作使用 Flame 定位程序执行慢的问题。</p>
<h3 id=debugging>Debugging</h3>
<h3 id=runtime-statistics-and-events>Runtime statistics and events</h3>
<h2 id=实践>实践</h2>
<p>定位高延迟的服务。</p>
<p>使用 logrus 打印日志文件，其中 Logrus 使用全局锁导致，goroutine 之间竞争写锁。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-golang data-lang=golang>
<span style=color:#204a87;font-weight:700>func</span> <span style=color:#000;font-weight:700>(</span><span style=color:#000>entry</span> <span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>Entry</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000>write</span><span style=color:#000;font-weight:700>()</span> <span style=color:#000;font-weight:700>{</span>
	<span style=color:#000>entry</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Logger</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>mu</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Lock</span><span style=color:#000;font-weight:700>()</span>
	<span style=color:#204a87;font-weight:700>defer</span> <span style=color:#000>entry</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Logger</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>mu</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Unlock</span><span style=color:#000;font-weight:700>()</span>
	<span style=color:#000>serialized</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>err</span> <span style=color:#ce5c00;font-weight:700>:=</span> <span style=color:#000>entry</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Logger</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Formatter</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Format</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>entry</span><span style=color:#000;font-weight:700>)</span>
	<span style=color:#204a87;font-weight:700>if</span> <span style=color:#000>err</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>nil</span> <span style=color:#000;font-weight:700>{</span>
		<span style=color:#000>fmt</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Fprintf</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>os</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Stderr</span><span style=color:#000;font-weight:700>,</span> <span style=color:#4e9a06>&#34;Failed to obtain reader, %v\n&#34;</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>err</span><span style=color:#000;font-weight:700>)</span>
	<span style=color:#000;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#000;font-weight:700>{</span>
		<span style=color:#000>_</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>err</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#000>entry</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Logger</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Out</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Write</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>serialized</span><span style=color:#000;font-weight:700>)</span>
		<span style=color:#204a87;font-weight:700>if</span> <span style=color:#000>err</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>nil</span> <span style=color:#000;font-weight:700>{</span>
			<span style=color:#000>fmt</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Fprintf</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>os</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Stderr</span><span style=color:#000;font-weight:700>,</span> <span style=color:#4e9a06>&#34;Failed to write to log, %v\n&#34;</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>err</span><span style=color:#000;font-weight:700>)</span>
		<span style=color:#000;font-weight:700>}</span>
	<span style=color:#000;font-weight:700>}</span>
<span style=color:#000;font-weight:700>}</span>

</code></pre></div><p>在这篇 <a href=https://www.reddit.com/r/golang/comments/6irpt1/is_there_a_golang_logging_library_around_that/dj8m1sk/>Is there a golang logging library around that doesn&rsquo;t lock the calling goroutine for logging?</a> 链接里也提到 logrus 写锁怎么处理</p>
<ul>
<li>协程异步写日志，但是会占内存</li>
<li>换 zap 库</li>
</ul>
<p>其实并没有解答为什么延迟非常高的问题。</p>
<h2 id=todo>TODO</h2>
<p><a href=https://www.cnblogs.com/charlieroro/p/10180827.html>docker cgroup 技术之 memory</a> 看起来挺详细的分析文档，待细看。</p>
<p><a href=https://colobu.com/2019/08/28/go-memory-leak-i-dont-think-so/>Go 内存泄漏？ 不是那么简单</a></p>
<p><a href=https://www.cnblogs.com/qcrao-2018/p/10520785.html>图解 Go 语言内存分配</a></p>
<p><a href=https://www.pengrl.com/p/29054/>Go语言使用cgo时的内存管理笔记</a>, 简单教你如何定位cgo导致的内存泄漏</p>
<p><a href=https://povilasv.me/go-memory-management-part-3/>cgo内存分析 进阶版</a>, 三部曲，英文.</p>
<p>Rakyll 一系列的调优</p>
<h2 id=参考>参考</h2>
<ol>
<li>
<p>go tool proof 郝琳的中文说明 #TODO
<a href=https://github.com/hyper0x/go_command_tutorial/blob/master/0.12.md>https://github.com/hyper0x/go_command_tutorial/blob/master/0.12.md</a></p>
</li>
<li>
<p>Profiling Go Programs 官方 Blog #TODO
<a href=https://blog.golang.org/pprof>https://blog.golang.org/pprof</a></p>
</li>
<li>
<p>一次 Golang 程序内存泄漏分析之旅
<a href=http://lday.me/2017/09/02/0012_a_memory_leak_detection_procedure/>http://lday.me/2017/09/02/0012_a_memory_leak_detection_procedure/</a> 链接访问有点问题，可以用 google cache 查看文字</p>
</li>
<li>
<p>一次 Golang 程序延迟过大问题的定位过程
<a href=http://lday.me/2017/09/13/0013_a_latency_identification_procedure/>http://lday.me/2017/09/13/0013_a_latency_identification_procedure/</a></p>
</li>
<li>
<p>go tool trace
<a href=https://making.pusher.com/go-tool-trace/>https://making.pusher.com/go-tool-trace/</a> #TODO</p>
</li>
<li>
<p>Go 程序的性能监控与分析 pprof
<a href=https://www.cnblogs.com/sunsky303/p/11058808.html>https://www.cnblogs.com/sunsky303/p/11058808.html</a></p>
</li>
<li>
<p>Rhys Hiltner - An Introduction to &ldquo;go tool trace&rdquo;
<a href="https://www.youtube.com/watch?v=V74JnrGTwKA">https://www.youtube.com/watch?v=V74JnrGTwKA</a></p>
</li>
<li>
<p>关于 Go 程序调式、分析和优化 来自 Brad Fitzpatrick 的分享 #TODO
<a href=https://studygolang.com/articles/4716>https://studygolang.com/articles/4716</a></p>
</li>
<li>
<p>Golang remote profiling and flamegraphs, 对各种图阐述的比较清晰
<a href=https://matoski.com/article/golang-profiling-flamegraphs/>https://matoski.com/article/golang-profiling-flamegraphs/</a></p>
</li>
<li>
<p>Using Go 1.10 new trace features to debug an integration test, 这边文章描述了 trace 使用过程，赞
<a href=https://medium.com/@cep21/using-go-1-10-new-trace-features-to-debug-an-integration-test-1dc39e4e812d>https://medium.com/@cep21/using-go-1-10-new-trace-features-to-debug-an-integration-test-1dc39e4e812d</a></p>
</li>
<li>
<p>Profiling Go programs with pprof #TODO
<a href=https://jvns.ca/blog/2017/09/24/profiling-go-with-pprof/>https://jvns.ca/blog/2017/09/24/profiling-go-with-pprof/</a></p>
</li>
<li>
<p>rakyll blog #TODO
<a href=https://rakyll.org/archive/>https://rakyll.org/archive/</a>
<br></p>
</li>
<li>
<p>Diagnostics 官文 #TODO
<a href=https://golang.org/doc/diagnostics.html>https://golang.org/doc/diagnostics.html</a></p>
</li>
<li>
<p>实战 Go 内存泄漏
<a href=https://segmentfault.com/a/1190000019222661>https://segmentfault.com/a/1190000019222661</a></p>
</li>
</ol>
<center> ·End· </center>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-f691475805d1a40b7cd3005ba6a3c434>4 - Gorm</h1>
<p>TIME_WATI 数量达到 300 多个， 连接中的数量只有几个。</p>
<h2 id=设置>设置</h2>
<p>设置下最大连接数（100）和闲置连接数（50）以及<del>连接的时间（1 小时）</del></p>
<p>从 [2] 文章测评来看，unlimited ConnMaxLifetime 的情况下，时间和内存分配上都会少。 该 ConnMaxLifetime 使用场景如：</p>
<blockquote>
<p>你的 SQL 数据库实现了最大的连接生存期， 或你希望在负载均衡器后面方便的切换数据库 （这句话不是很懂）</p>
</blockquote>
<h3 id=setmaxidleconns-设置>SetMaxIdleConns 设置</h3>
<p>维护一个大的空闲连接池，副作用是有的，占用内存。另外一种可能是，如果一个连接空闲太久，那么它也可能变得不可用。例如 Mysql 的 wait_timeout 设置将自动关闭 8 小时内未使用的任何连接（默认情况下）， 当发生这种情况时，sql.DB 会优雅的处理它。 在放弃之前，将自动重试两次连接，之后 Go 将从池中删除坏连接并创建新连接。</p>
<h3 id=超出连接限制>超出连接限制</h3>
<p>如果数据连接限制为 5 个，一旦达到 5 个连接的硬限制，pg 数据库驱动程序立即返回一条 sorry, too many clients already 错误信息， 而不是完成插入操作。</p>
<h2 id=参考>参考</h2>
<ol>
<li>
<p>分析 golang sql 连接池大量的 time wait 问题
<a href=http://xiaorui.cc/archives/5771>http://xiaorui.cc/archives/5771</a></p>
</li>
<li>
<p>配置 sql.DB 获得更好的性能
<a href=https://colobu.com/2019/05/27/configuring-sql-DB-for-better-performance/>https://colobu.com/2019/05/27/configuring-sql-DB-for-better-performance/</a></p>
</li>
</ol>
<br>
<center> ·End· </center>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-762d41fcff5885e1e92c42644dfdb847>5 - Golang语言之禅</h1>
<h2 id=理解>理解</h2>
<h3 id=each-package-fulfils-a-single-purpose--保持每个package的单一目的性>Each package fulfils a single purpose 保持每个package的单一目的性</h3>
<blockquote>
<p>A well designed Go package provides a single idea, a set of related behaviours.
A good Go package starts by choosing a good name.
Think of your package&rsquo;s name as an elevator pitch to describe what it provides, using just one word.</p>
</blockquote>
<h3 id=handle-errors-explicitly--显式处理errors>Handle errors explicitly 显式处理errors</h3>
<p>Robust programs are composed from pieces that handle the failure cases before they pat themselves on the back.
The verbosity of <code>if err != nil { return err }</code> is outweighed by the value of deliberately handling each failure condition at the point at which they occur.
Panic and recover are not exceptions, they aren&rsquo;t intended to be used that way.</p>
<h3 id=return-early-rather-than-nesting-deeply--提前返回胜过深嵌套>Return early rather than nesting deeply 提前返回胜过深嵌套</h3>
<p>Every time you indent you add another precondition to the programmer&rsquo;s stack consuming one of the 7 ±2 slots in their short term memory.
Avoid control flow that requires deep indentation.
Rather than nesting deeply, keep the success path to the left using guard clauses.</p>
<h3 id=leave-concurrency-to-the-caller--把并发交给调用者>Leave concurrency to the caller 把并发交给调用者</h3>
<p>Let the caller choose if they want to run your library or function asynchronously, don&rsquo;t force it on them. If your library uses concurrency it should do so transparently.</p>
<h3 id=before-you-launch-a-goroutine-know-when-it-will-stop-使用goroutine之前想清楚它什么时候结束>Before you launch a goroutine, know when it will stop 使用goroutine之前想清楚它什么时候结束</h3>
<p>Goroutines own resources; locks, variables, memory, etc.
The sure fire way to free those resources is to stop the owning goroutine.</p>
<h3 id=avoid-package-level-state>Avoid package level state</h3>
<p>Seek to be explicit, reduce coupling, and spooky action at a distance by providing the dependencies a type needs as fields on that type rather than using package variables.</p>
<h3 id=simplicity-matters>Simplicity matters</h3>
<p>Simplicity is not a synonym for unsophisticated.
Simple doesn&rsquo;t mean crude, it means <em>readable</em> and <em>maintainable</em>.
When it is possible to choose, defer to the simpler solution.</p>
<h3 id=write-tests-to-lock-in-the-behaviour-of-your-packages-api--编写单元测试保证package-api行为>Write tests to lock in the behaviour of your package&rsquo;s API 编写单元测试，保证Package API行为</h3>
<p>Test first or test later, if you shoot for 100% test coverage or are happy with less, regardless your package&rsquo;s API is your contract with its users.
Tests are the guarantees that those contracts are written in.
Make sure you test for the behaviour that users can observe and rely on.</p>
<h3 id=if-you-think-its-slow-first-prove-it-with-a-benchmark>If you think it&rsquo;s slow, first prove it with a benchmark</h3>
<p>So many crimes against maintainability are committed in the name of performance.
Optimisation tears down abstractions, exposes internals, and couples tightly.
If you&rsquo;re choosing to shoulder that cost, ensure it is done for good reason.</p>
<h3 id=moderation-is-a-virtue>Moderation is a virtue</h3>
<p>Use goroutines, channels, locks, interfaces, embedding, in moderation.</p>
<h4 id=thress-attribute-of-channel>thress attribute of Channel</h4>
<ul>
<li>Gurarantee Of Delivery
<ul>
<li>Ticker的实现为什么使用Delayed Guarantee类型的Channel</li>
<li>Ticker为什么会丢失</li>
</ul>
</li>
<li>State</li>
<li>With or Without Data</li>
</ul>
<h3 id=maintainability-counts-可维护性>Maintainability counts 可维护性</h3>
<p>Clarity, readability, simplicity, are all aspects of maintainability.
Can the thing you worked hard to build be maintained after you’re gone?
What can you do today to make it easier for those that come after you?</p>
<p>翻译原文： <a href=https://github.com/davecheney/the-zen-of-go>https://github.com/davecheney/the-zen-of-go</a></p>
<h2 id=参考>参考</h2>
<ol>
<li>
<p>The Behavior Of Channels #TODO
<a href=https://www.ardanlabs.com/blog/2017/10/the-behavior-of-channels.html>https://www.ardanlabs.com/blog/2017/10/the-behavior-of-channels.html</a></p>
</li>
<li>
<p>Go proverbs
<a href=https://www.kancloud.cn/cserli/golang/524388>https://www.kancloud.cn/cserli/golang/524388</a></p>
</li>
</ol>
<br>
<center> ·End· </center>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-7d846e61c330595767c77bde2caf83bc>6 - Code Review 开始</h1>
<h2 id=简介>简介</h2>
<p>整个golang团队20多人，没有code review ，对项目质量、对结果产出、对新人的成长，对团队交流的氛围影响大。 看过<a href=https://www.infoq.cn/article/QJi1Kqm4pH3UNAqNzl3l>Google 代码评审规范</a>，解决了我之前一些疑问和也让我坚定的去Code Review。<br>
当没有code review时候，要求重构，而重构价值是释放历史包袱，并没有产生任何其他价值</p>
<ul>
<li>我们的提交是这样的</li>
</ul>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-golang data-lang=golang><span style=color:#0000cf;font-weight:700>3</span><span style=color:#000>b8e45c</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#000>Slove</span> <span style=color:#000>Confilct</span> <span style=color:#ce5c00;font-weight:700>-</span>  <span style=color:#0000cf;font-weight:700>2</span> <span style=color:#000>weeks</span> <span style=color:#000>ago</span> <span style=color:#ce5c00;font-weight:700>-</span>
<span style=color:#0000cf;font-weight:700>0</span><span style=color:#000>a39ecd</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#000>FIXS</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000>vendor</span> <span style=color:#ce5c00;font-weight:700>-</span>  <span style=color:#0000cf;font-weight:700>2</span> <span style=color:#000>weeks</span> <span style=color:#000>ago</span> <span style=color:#ce5c00;font-weight:700>-</span>
<span style=color:#0000cf;font-weight:700>7817</span><span style=color:#000>d14</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#000>debug</span> <span style=color:#ce5c00;font-weight:700>-</span>  <span style=color:#0000cf;font-weight:700>2</span> <span style=color:#000>weeks</span> <span style=color:#000>ago</span> <span style=color:#ce5c00;font-weight:700>-</span>
<span style=color:#0000cf;font-weight:700>67539e2</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#000>debug</span> <span style=color:#ce5c00;font-weight:700>-</span>  <span style=color:#0000cf;font-weight:700>2</span> <span style=color:#000>weeks</span> <span style=color:#000>ago</span> <span style=color:#ce5c00;font-weight:700>-</span>
<span style=color:#0000cf;font-weight:700>9044356</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#000>Slove</span> <span style=color:#000>Confilct</span> <span style=color:#ce5c00;font-weight:700>-</span>  <span style=color:#0000cf;font-weight:700>2</span> <span style=color:#000>weeks</span> <span style=color:#000>ago</span> <span style=color:#ce5c00;font-weight:700>-</span>
<span style=color:#000>d47db91</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#000>FIXS</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000>ss</span> <span style=color:#ce5c00;font-weight:700>-</span>  <span style=color:#0000cf;font-weight:700>2</span> <span style=color:#000>weeks</span> <span style=color:#000>ago</span> <span style=color:#ce5c00;font-weight:700>-</span>
<span style=color:#0000cf;font-weight:700>8913</span><span style=color:#000>c30</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#000>Slove</span> <span style=color:#000>Confilct</span> <span style=color:#ce5c00;font-weight:700>-</span>  <span style=color:#0000cf;font-weight:700>2</span> <span style=color:#000>weeks</span> <span style=color:#000>ago</span> <span style=color:#ce5c00;font-weight:700>-</span>
<span style=color:#0000cf;font-weight:700>2</span><span style=color:#000>d407d2</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#000>FIXS</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000>logger</span> <span style=color:#ce5c00;font-weight:700>-</span>  <span style=color:#0000cf;font-weight:700>2</span> <span style=color:#000>weeks</span> <span style=color:#000>ago</span> <span style=color:#ce5c00;font-weight:700>-</span>
</code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-golang data-lang=golang><span style=color:#000>b9af055</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#000>打印日志</span> <span style=color:#ce5c00;font-weight:700>-</span>  <span style=color:#0000cf;font-weight:700>7</span> <span style=color:#000>weeks</span> <span style=color:#000>ago</span> <span style=color:#ce5c00;font-weight:700>-</span> 
<span style=color:#0000cf;font-weight:700>1124e92</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#000>打印日志</span> <span style=color:#ce5c00;font-weight:700>-</span>  <span style=color:#0000cf;font-weight:700>7</span> <span style=color:#000>weeks</span> <span style=color:#000>ago</span> <span style=color:#ce5c00;font-weight:700>-</span> 
<span style=color:#0000cf;font-weight:700>88</span><span style=color:#000>d0eac</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#000>修改log</span> <span style=color:#ce5c00;font-weight:700>-</span>  <span style=color:#0000cf;font-weight:700>7</span> <span style=color:#000>weeks</span> <span style=color:#000>ago</span> <span style=color:#ce5c00;font-weight:700>-</span> 
<span style=color:#000>ad0b3dd</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#000>修改日志</span> <span style=color:#ce5c00;font-weight:700>-</span>  <span style=color:#0000cf;font-weight:700>7</span> <span style=color:#000>weeks</span> <span style=color:#000>ago</span> <span style=color:#ce5c00;font-weight:700>-</span> 
<span style=color:#0000cf;font-weight:700>4</span><span style=color:#000>aa0740</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#000>答应日志</span> <span style=color:#ce5c00;font-weight:700>-</span>  <span style=color:#0000cf;font-weight:700>7</span> <span style=color:#000>weeks</span> <span style=color:#000>ago</span> <span style=color:#ce5c00;font-weight:700>-</span> 
<span style=color:#0000cf;font-weight:700>824658</span><span style=color:#000>a</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#000>修改日志</span> <span style=color:#ce5c00;font-weight:700>-</span>  <span style=color:#0000cf;font-weight:700>7</span> <span style=color:#000>weeks</span> <span style=color:#000>ago</span> <span style=color:#ce5c00;font-weight:700>-</span> 
<span style=color:#0000cf;font-weight:700>178</span><span style=color:#000>c30c</span> <span style=color:#ce5c00;font-weight:700>-</span> <span style=color:#000>打印日志</span> <span style=color:#ce5c00;font-weight:700>-</span>  <span style=color:#0000cf;font-weight:700>7</span> <span style=color:#000>weeks</span> <span style=color:#000>ago</span> <span style=color:#ce5c00;font-weight:700>-</span> 
</code></pre></div><blockquote>
<p>在pull request的时候，认真review下所有的commit，该合并得合并，该修改得修改</p>
</blockquote>
<ul>
<li>
<p>我们的命名是这样的<br>
这里不截图纪念了.</p>
</li>
<li>
<p>我们的代码分支和发版是这样的<br>
本地打包,更恶心的是代码不提交本地打包的.</p>
</li>
<li>
<p>我们的单元测试是这样的<br>
几乎没有</p>
</li>
</ul>
<p>我们开始要做Code Review， 从哪里开始了？</p>
<h2 id=方式>方式</h2>
<p>谁对谁在什么时候用什么方式去做什么？</p>
<h3 id=第一个谁>第一个“谁”</h3>
<h4 id=代码评审员>代码评审员</h4>
<p>如果项目存在两人或者两人以上开发</p>
<ul>
<li>如果开发提交代码，则应用项目负责人</li>
<li>如果应用负责人也参与开发，则由另外任一一位开发做一次review，然后上一级的负责人做第二次review。</li>
</ul>
<p>如果应用负责人和开发是同一个人，这时候为“小组Leader”</p>
<h4 id=自动lint工具>自动Lint工具</h4>
<p>借助自动化完成代码最基本的审核， 比如reviewdog & golangci-lint， 更多相关知识<a href=https://github.com/reviewdog/action-golangci-lint>Github Action-golangci-lint</a></p>
<h3 id=第二个谁>第二个“谁”</h3>
<p>业务开发人员对应用提交的pull request</p>
<h3 id=什么时候>什么时候</h3>
<p>提交Review时的当天或者第二天须完成</p>
<h3 id=什么方式>什么方式</h3>
<p>依照代码审核规范， 目前缺少自己的审核规范，
类似规范参考</p>
<ul>
<li>代码审查规范
<ul>
<li><a href=https://www.infoq.cn/article/QJi1Kqm4pH3UNAqNzl3l>Google 代码评审规范</a></li>
<li><a href=https://jimmysong.io/eng-practices/>谷歌工程实践 by jimmysong</a></li>
</ul>
</li>
<li>代码规范[golang]
<ul>
<li><a href=https://www.bwplotka.dev/2020/how-thanos-would-program-in-go/>How Thanos Would Program in Go</a>
<ul>
<li>参考runutil包解决defer中error的检查问题, 相比写匿名函数更加的优雅</li>
<li>包 <code>pkg/errors</code> 比标准的<code>fmt.Errorf</code> + <code>%w</code>更可读</li>
<li>待补充</li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 id=做什么>做什么</h3>
<p>阅读提交的代码并给出建议完成审核</p>
<h2 id=落地>落地</h2>
<h3 id=reviewdog--golangci-lint在gitlab上配置实践>reviewdog & golangci-lint在gitlab上配置实践</h3>
<p>熟悉github action方式， 借鉴其优点； 在一个项目中实践，然后推广到其他项目中。</p>
<ul>
<li>如何做到所有项目不需要自行配置或者简单的配置（比如增加一个配置现成的文件），并且使用同一个套代码检查标准？
<ul>
<li><del>制作包含reviewdog.yml的配置文件，如果做linter升级的话，更新tag为latest最新的镜像即可.</del>, 已经完成了</li>
<li><del>在一半的项目上增加reviewdog</del></li>
<li>目前linter设置为golint和errcheck方式, 下一步增加golangci-lint检查代码</li>
</ul>
</li>
<li>目前没有非常成熟的方案，需要花费一些时间去解决现有开源方案中的问题。
<ul>
<li><em>reviewdog 结合 golangci-lint 使用，修改其输出格式, <a href=https://gitlab.com/Hyvi/reviewdog-test/-/blob/gitlab-ci-test2/.gitlab-ci.yml>more link</a></em>
在<a href=https://github.com/calmato/presto-pay/blob/master/api/user/Makefile>presto-pay</a>是使用golangci-lint,但是reviewdog在官网上没有golangci-lint的案例</li>
</ul>
</li>
</ul>
<p><strong>失败</strong></p>
<ul>
<li>golangci-lint自身大而全的能力，导致其功能本身不稳定，不如golint或errcheck那么纯粹</li>
</ul>
<h3 id=reviewdog--golinterrcheckgovet-在-gitlab-上配置实践>reviewdog & golint/errcheck/govet/&mldr; 在 gitlab 上配置实践</h3>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yml data-lang=yml><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>reviewdog</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>stage</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>review</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#8f5902;font-style:italic># 自定义镜像, 包含统一的reviewdog配置文件和需要安装的reviewdog/golangci-lint版本</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>image</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>golang:custom-latest</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>before_script</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#000>curl -sfL https://raw.githubusercontent.com/reviewdog/reviewdog/master/install.sh| sh -s -- -b $(go env GOPATH)/bin v0.10.0</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#000>curl -sSfL https://raw.githubusercontent.com/golangci/golangci-lint/master/install.sh | sh -s -- -b $(go env GOPATH)/bin v1.27.0</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#000>export GITLAB_API=&#34;https://examplegitlab.com/api/v4&#34;  </span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>script</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#000>reviewdog -conf=/etc/reviewdog/reviewdog.yml  -reporter=gitlab-mr-discussion  -guess -fail-on-error=true</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>only</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#000>merge_requests</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div><p>reviewdog.yml 配置如下</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yml data-lang=yml><span style=color:#204a87;font-weight:700>runner</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>golangci</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>cmd</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>golangci-lint run --config=/etc/reviewdog/golangci/golangci.yml ./...</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>errorformat</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>      </span>- <span style=color:#204a87;font-weight:700>&#39;%E%f:%l:%c</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>%m&#39;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>      </span>- <span style=color:#204a87;font-weight:700>&#39;%E%f:%l</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>%m&#39;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>      </span>- <span style=color:#4e9a06>&#39;%C%.%#&#39;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>level</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>warning</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div><p>更多：</p>
<ul>
<li>reviewdog 结合各种错误检查，详细见: <a href=https://gitlab.com/reviewdog/reviewdog/-/blob/master/.reviewdog.yml>reviewdog.yml</a></li>
<li>使用预设的errformat, 例如通过参数<code>-f=golangci-lint</code>，更多的预设errformat使用 <code>reviewdog -list</code> 查看， 点击链接<a href=https://github.com/reviewdog/errorformat/blob/master/fmts/go.go> go.go </a></li>
<li>在gitlab里配置参考gitlab上的工程：<a href=https://gitlab.com/Hyvi/reviewdog-test/-/blob/gitlab-ci-test2/.gitlab-ci.yml>reviewdog test</a></li>
<li>exit code的处理
<ul>
<li>errcheck 命令在检查到 err 时，exit code为0 （通过echo $?查看, 更多查看<a href=https://www.tldp.org/LDP/abs/html/exit-status.html#EXITSTATUSREF>Chapter 6. Exit and Exit Status</a>）</li>
<li>reviewdog默认的 exit code 为0， 当加上 -fail-on-error=true时候则会返回1（当检查到不规范的时候）</li>
<li>errcheck | reviewdog 根据现象是当errcheck 的 exit code 为1时，job会失败。 解决办法是 ( errcheck 2>&1 || true ) | reviewdog</li>
</ul>
</li>
</ul>
<p>在这个过程中，不断增加的检查机制, 并说明理由\目的</p>
<p><a href=https://github.com/thanos-io/thanos>thanos</a> 代码规范推荐的代码 linter 工具 <code>go vet</code>, 同时也推荐 golangci-lint,
但 golangci-lint 无法配置的原因, 将考虑一个个配置其默认的 <a href=https://golangci-lint.run/usage/linters/>linter</a> , 建议参考Thanos 里配置的 <a href=https://www.bwplotka.dev/2020/how-thanos-would-program-in-go/#golangci-lint>linters</a></p>
<ul>
<li>govet</li>
<li>errcheck</li>
<li>staticcheck</li>
<li>unused</li>
<li>gosimple</li>
<li>structcheck</li>
<li>varcheck</li>
<li>ineffassign</li>
<li>deadcode</li>
<li>typecheck</li>
</ul>
<h4 id=golint>golint</h4>
<h4 id=errcheck>errcheck</h4>
<h4 id=go-vet>go vet</h4>
<h2 id=todo>TODO</h2>
<p>反复阅读代码评审规范.
不断增加或修正 linter</p>
<h2 id=参考>参考</h2>
<ol>
<li>
<p>reviewdog
<a href=https://github.com/reviewdog/reviewdog#reporter-github-pullrequest-review-comment--reportergithub-pr-review>https://github.com/reviewdog/reviewdog#reporter-github-pullrequest-review-comment--reportergithub-pr-review</a></p>
</li>
<li>
<p>golangci-lint
<a href=https://github.com/golangci/golangci-lint>https://github.com/golangci/golangci-lint</a></p>
</li>
</ol>
<br>
<center> ·End· </center>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-2ba8936b35c18b67399290e83295cff1>7 - Gomonkey Test</h1>
<h2 id=简述>简述</h2>
<p>项目中重视单元测试，选择使用简单的第三库来实现 mock，是至关重要的，有太多的方法、依赖、全局变量需要 Mock。</p>
<h2 id=各领风骚>各领风骚</h2>
<h3 id=gomonkey>gomonkey</h3>
<p><a href=https://github.com/agiledragon/gomonkey>gomonkey is a library to make monkey patching in unit tests easy </a></p>
<blockquote>
<p>gomonkey should work on any amd64 system</p>
</blockquote>
<h3 id=heading>&mldr;</h3>
<h2 id=只取一瓢>只取一瓢</h2>
<ul>
<li>Tsung is an open-source distributed load testing tool that makes it easy to stress test websockets (as well as many other protocols.)， 比如对 Websocket 长连接的压测<sup>[3]</sup></li>
</ul>
<h2 id=参考>参考</h2>
<p>[1] <a href=https://blog.csdn.net/wf19930209/article/details/79536506>X86、X86_64 和 AMD64 的由来</a></p>
<blockquote>
<p>时机落后的 Intel 开始支持 AMD64 的指令集， 但是换了名字，叫x84_64， 表示x86指令集的64扩展<br>
<strong>x86_64, x64, AMD64</strong> 基本上是同一个东西</p>
</blockquote>
<p>[2] [gomonkey 博主简书] (<a href=https://www.jianshu.com/u/1381dc29fed9>https://www.jianshu.com/u/1381dc29fed9</a>) golang开发</p>
<p>[3] Gary Rennie: The Road to 2 Million Websocket Connections in Phoenix.</p>
<p>[4] eranyanay: Going Infinite, handling 1M websockets connections in Go
<br></p>
<center> ·End· </center>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-90baeac0d8907b563e8b6e698754f11a>8 - Daily 0131 Golang 杂乱</h1>
<h2 id=golang-还是学习吧>golang, 还是学习吧</h2>
<p><strong>已经两个月没有更新了</strong></p>
<h3 id=guru-for-vim-go-todo>guru for vim-go #TODO</h3>
<p><a href=https://docs.google.com/document/d/1_Y9xCEMj5S-7rv2ooHpZNH15JgRT5iM742gJkw5LtmQ/edit#>Using Go Guru</a> 详细介绍了 guru 功能点</p>
<p><a href=https://github.com/fatih/vim-go/wiki/Tutorial#guru>vim go tutorial#guru</a> 看到对 scope 的介绍，简单易懂的教程。</p>
<blockquote>
<p>Pointer analysis scope: some queries involve pointer analysis, a technique for answering questions of the form &ldquo;what might this pointer point to?&rdquo;.</p>
</blockquote>
<blockquote>
<p>vim-go automatically tries to be smaart and sets the current packages import path as the scope for you.</p>
</blockquote>
<h3 id=go-stack>go stack</h3>
<p>了解 golang runtime 的堆栈信息，学习如何查看 golang stack trace</p>
<p><a href=https://segmentfault.com/a/1190000017498101>Go 堆栈的理解</a></p>
<ul>
<li>堆栈跟踪，堆栈的参数</li>
<li>变量是在堆 ( heap ) 还是堆栈 ( stack ) 上</li>
</ul>
<h3 id=go-list>go list</h3>
<p>如何列出依赖的外部 package <a href=https://groups.google.com/forum/#!topic/golang-nuts/611QEJqkDKw>List external dependencies of package</a></p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-golang data-lang=golang><span style=color:#204a87;font-weight:700>go</span> <span style=color:#000>list</span> <span style=color:#ce5c00;font-weight:700>-</span><span style=color:#000>f</span> <span style=color:#a40000>&#39;</span><span style=color:#000;font-weight:700>{{</span><span style=color:#000>join</span> <span style=color:#000;font-weight:700>.</span><span style=color:#000>Deps</span> <span style=color:#4e9a06>&#34;\n&#34;</span><span style=color:#000;font-weight:700>}}</span><span style=color:#a40000>&#39;</span> <span style=color:#000;font-weight:700>|</span>  <span style=color:#000>xargs</span> <span style=color:#204a87;font-weight:700>go</span> <span style=color:#000>list</span> <span style=color:#ce5c00;font-weight:700>-</span><span style=color:#000>f</span> <span style=color:#a40000>&#39;</span><span style=color:#000;font-weight:700>{{</span><span style=color:#204a87;font-weight:700>if</span> <span style=color:#000>not</span> <span style=color:#000;font-weight:700>.</span><span style=color:#000>Standard</span><span style=color:#000;font-weight:700>}}{{.</span><span style=color:#000>ImportPath</span><span style=color:#000;font-weight:700>}}{{</span><span style=color:#000>end</span><span style=color:#000;font-weight:700>}}</span><span style=color:#a40000>&#39;</span>
</code></pre></div><p>或者使用 <a href=https://github.com/cespare/deplist>deplist</a></p>
<h4 id=go-modules-410-gone>go modules 410 Gone</h4>
<p>原因： 由于你的 go 库声明为 go1.12 格式，此时将没有 SUMDB 校验信息，因而在一个 go1.13 项目中引用这样的旧的库格式会产生校验错误，进而报错为 410 Gone。</p>
<p>解决办法：</p>
<ul>
<li>对于使旧格式库的人来说， 以下方式帮你顺利下载库和完成引用。</li>
</ul>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#204a87>export</span> <span style=color:#000>GONOSUMDB</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;github.com/hedzr/errors,</span><span style=color:#000>$GONOSUMDB</span><span style=color:#4e9a06>&#34;</span>
<span style=color:#8f5902;font-style:italic>## OR</span>

<span style=color:#204a87>export</span> <span style=color:#000>GOSUMDB</span><span style=color:#ce5c00;font-weight:700>=</span>off
</code></pre></div><ul>
<li>对于该库的拥有者而言，下面的办法是正确的处理方案，在 go.mod 中修改库宣告的版本格式为 1.13. 例如：</li>
</ul>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-golang data-lang=golang><span style=color:#000>module</span> <span style=color:#000>github</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>com</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>hedzr</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>errors</span>

<span style=color:#204a87;font-weight:700>go</span> <span style=color:#0000cf;font-weight:700>1.13</span>  <span style=color:#8f5902;font-style:italic>// go 1.12
</span><span style=color:#8f5902;font-style:italic></span>
</code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-golang data-lang=golang><span style=color:#204a87;font-weight:700>package</span> <span style=color:#000>main</span>
<span style=color:#204a87;font-weight:700>import</span> <span style=color:#000;font-weight:700>(</span>
  <span style=color:#4e9a06>&#34;encoding/json&#34;</span>
  <span style=color:#4e9a06>&#34;net/http&#34;</span>
<span style=color:#000;font-weight:700>)</span>
<span style=color:#204a87;font-weight:700>type</span> <span style=color:#000>Profile</span> <span style=color:#204a87;font-weight:700>struct</span> <span style=color:#000;font-weight:700>{</span>
  <span style=color:#000>Name</span>    <span style=color:#204a87;font-weight:700>string</span>
  <span style=color:#000>Hobbies</span> <span style=color:#000;font-weight:700>[]</span><span style=color:#204a87;font-weight:700>string</span>
<span style=color:#000;font-weight:700>}</span>
<span style=color:#204a87;font-weight:700>func</span> <span style=color:#000>main</span><span style=color:#000;font-weight:700>()</span> <span style=color:#000;font-weight:700>{</span>
  <span style=color:#000>http</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>HandleFunc</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#34;/&#34;</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>foo</span><span style=color:#000;font-weight:700>)</span>
  <span style=color:#000>http</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>ListenAndServe</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#34;:3000&#34;</span><span style=color:#000;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>nil</span><span style=color:#000;font-weight:700>)</span>
<span style=color:#000;font-weight:700>}</span>
<span style=color:#204a87;font-weight:700>func</span> <span style=color:#000>foo</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>w</span> <span style=color:#000>http</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>ResponseWriter</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>r</span> <span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>http</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Request</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{</span>
  <span style=color:#000>profile</span> <span style=color:#ce5c00;font-weight:700>:=</span> <span style=color:#000>Profile</span><span style=color:#000;font-weight:700>{</span><span style=color:#4e9a06>&#34;Alex&#34;</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000;font-weight:700>[]</span><span style=color:#204a87;font-weight:700>string</span><span style=color:#000;font-weight:700>{</span><span style=color:#4e9a06>&#34;snowboarding&#34;</span><span style=color:#000;font-weight:700>,</span> <span style=color:#4e9a06>&#34;programming&#34;</span><span style=color:#000;font-weight:700>}}</span>
  <span style=color:#000>js</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>err</span> <span style=color:#ce5c00;font-weight:700>:=</span> <span style=color:#000>json</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Marshal</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>profile</span><span style=color:#000;font-weight:700>)</span>
  <span style=color:#204a87;font-weight:700>if</span> <span style=color:#000>err</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>nil</span> <span style=color:#000;font-weight:700>{</span>
    <span style=color:#000>http</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Error</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>w</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>err</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Error</span><span style=color:#000;font-weight:700>(),</span> <span style=color:#000>http</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>StatusInternalServerError</span><span style=color:#000;font-weight:700>)</span>
    <span style=color:#204a87;font-weight:700>return</span>
  <span style=color:#000;font-weight:700>}</span>
  <span style=color:#000>w</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Header</span><span style=color:#000;font-weight:700>().</span><span style=color:#000>Set</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#34;Content-Type&#34;</span><span style=color:#000;font-weight:700>,</span> <span style=color:#4e9a06>&#34;application/json&#34;</span><span style=color:#000;font-weight:700>)</span>
  <span style=color:#000>w</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Write</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>js</span><span style=color:#000;font-weight:700>)</span>
<span style=color:#000;font-weight:700>}</span>

</code></pre></div><p>先来段 go 代码，上面代码是返回 JSON 数据，是不是郁闷，为什么还要定义 struct Profile，没有 python/js/ 等等灵活呀</p>
<p>再看下 GO 怎么读 JSON 数据的</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-GOlang data-lang=GOlang><span style=color:#204a87;font-weight:700>package</span> <span style=color:#000>main</span>

<span style=color:#204a87;font-weight:700>import</span> <span style=color:#000;font-weight:700>(</span>
	<span style=color:#4e9a06>&#34;encoding/json&#34;</span>
	<span style=color:#4e9a06>&#34;fmt&#34;</span>
	<span style=color:#4e9a06>&#34;net/http&#34;</span>
<span style=color:#000;font-weight:700>)</span>

<span style=color:#204a87;font-weight:700>type</span> <span style=color:#000>test_struct</span> <span style=color:#204a87;font-weight:700>struct</span> <span style=color:#000;font-weight:700>{</span>
	<span style=color:#000>Test</span> <span style=color:#204a87;font-weight:700>string</span>
<span style=color:#000;font-weight:700>}</span>

<span style=color:#204a87;font-weight:700>func</span> <span style=color:#000>parseGhPost</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>rw</span> <span style=color:#000>http</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>ResponseWriter</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>request</span> <span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>http</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Request</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{</span>
	<span style=color:#000>decoder</span> <span style=color:#ce5c00;font-weight:700>:=</span> <span style=color:#000>json</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>NewDecoder</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>request</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Body</span><span style=color:#000;font-weight:700>)</span>

	<span style=color:#204a87;font-weight:700>var</span> <span style=color:#000>t</span> <span style=color:#000>test_struct</span>
	<span style=color:#000>err</span> <span style=color:#ce5c00;font-weight:700>:=</span> <span style=color:#000>decoder</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Decode</span><span style=color:#000;font-weight:700>(</span><span style=color:#ce5c00;font-weight:700>&amp;</span><span style=color:#000>t</span><span style=color:#000;font-weight:700>)</span>

	<span style=color:#204a87;font-weight:700>if</span> <span style=color:#000>err</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>nil</span> <span style=color:#000;font-weight:700>{</span>
		<span style=color:#204a87>panic</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>err</span><span style=color:#000;font-weight:700>)</span>
	<span style=color:#000;font-weight:700>}</span>

	<span style=color:#000>fmt</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Println</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>t</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Test</span><span style=color:#000;font-weight:700>)</span>
<span style=color:#000;font-weight:700>}</span>

<span style=color:#204a87;font-weight:700>func</span> <span style=color:#000>main</span><span style=color:#000;font-weight:700>()</span> <span style=color:#000;font-weight:700>{</span>
	<span style=color:#000>http</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>HandleFunc</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#34;/&#34;</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>parseGhPost</span><span style=color:#000;font-weight:700>)</span>
	<span style=color:#000>http</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>ListenAndServe</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#34;:8080&#34;</span><span style=color:#000;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>nil</span><span style=color:#000;font-weight:700>)</span>
<span style=color:#000;font-weight:700>}</span>

</code></pre></div><p>*** curl -X POST -d &ldquo;{"test": "that"}&rdquo; http://localhost:8080 *** 测试</p>
<p><code>Bolt</code>是 GO 语言 key/value 存储数据库，</p>
<blockquote>
<p>The API will be small and only focus on getting values and setting values. That&rsquo;s it.</p>
</blockquote>
<blockquote>
<p>Bolt is currently used in high-load production environments serving databases as large as 1TB. Many companies such as Shopify and Heroku use Bolt-backed services every day.</p>
</blockquote>
<pre tabindex=0><code>db.Update(func(tx *bolt.Tx) error {
	b := tx.Bucket([]byte(&quot;MyBucket&quot;))
	err := b.Put([]byte(&quot;answer&quot;), []byte(&quot;42&quot;))
	return err
})
</code></pre><p>更新数据库 是不是写起来很费劲呀！</p>
<pre tabindex=0><code>db.View(func(tx *bolt.Tx) error {
	b := tx.Bucket([]byte(&quot;MyBucket&quot;))
	v := b.Get([]byte(&quot;answer&quot;))
	fmt.Printf(&quot;The answer is: %s\n&quot;, v)
	return nil
})
</code></pre><p>读数据一样，就不能直接 SET／GET 吗？</p>
<p>用 Go 自带的 http 参考这个文章 <a href=https://astaxie.gitbooks.io/build-web-application-with-golang/en/06.2.html>How to use sessions in Go</a> 写了 session 机制</p>
<p>技术选型：如何选择一个合适的 Go http routing 呢？ 那这篇文章告诉你答案：<a href=https://github.com/julienschmidt/go-http-routing-benchmark>go http routing benchmark</a></p>
<blockquote>
<p>This benchmark suite aims to compare the performance of HTTP request routers for Go by implementing the routing structure of some real world APIs. Some of the APIs are slightly adapted, since they can not be implemented 1:1 in some of the routers.</p>
</blockquote>
<p><a href=http://www.cnblogs.com/DjangoBlog/p/5267006.html>再 tornado 中异步无阻塞的执行耗时任务</a> 原理得看，run_on_executor 装饰器对传递进来的函数封装，用 io_loop. TODO</p>
<h4 id=罗列-go-资源>罗列 GO 资源：</h4>
<p><a href=https://github.com/dgryski/go-perfbook/blob/master/performance.md>Go perfbook</a> Writing and Optimizing Go code</p>
<p><a href=http://colobu.com/categories/Go/>Go 中文资料</a> 杂乱，须整理成自己的知识网</p>
<p><a href=https://github.com/valyala/fasthttp>fasthttp </a> 这个性能，相比 GO 自带的 http，相差很远</p>
<h4 id=ruby-点点滴滴奇奇怪怪>ruby 点点滴滴，奇奇怪怪</h4>
<p>[Ruby 中的 @ % # $ 等各种千奇百怪的符号的含义等』 (http://www.cnblogs.com/likeyu/archive/2012/02/22/2363912.html)
@开始是实例变量、@@开始的变量是类变量
$ 开始的变量是全局变量，在程序的任何地方都可以引用。</p>
<ul>
<li>若左边最后一个表达式前带<em>号的话，将右边多余的元素以数组的形式代入这个带</em>的表达式中。若右边没有多余元素的话，就把空数组代入其中</li>
</ul>
<p>?! 两个符号，一个表示布尔值，另外一个表示需要注意的</p>
<h3 id=参考>参考</h3>
<ol>
<li>
<p>go modules 410 Gone
<a href=https://juejin.im/post/5e0ec5d75188253aa20e858e>https://juejin.im/post/5e0ec5d75188253aa20e858e</a></p>
</li>
<li>
<p>Go Modules with Private Git Repositories
<a href=https://medium.com/cloud-native-the-gathering/go-modules-with-private-git-repositories-dfe795068db4>https://medium.com/cloud-native-the-gathering/go-modules-with-private-git-repositories-dfe795068db4</a></p>
</li>
</ol>
</div>
</main>
</div>
</div>
<footer class="bg-dark py-5 row d-print-none">
<div class="container-fluid mx-sm-5">
<div class=row>
<div class="col-6 col-sm-4 text-xs-center order-sm-2">
</div>
<div class="col-6 col-sm-4 text-right text-xs-center order-sm-3">
</div>
<div class="col-12 col-sm-4 text-center py-2 order-sm-2">
<small class=text-white>&copy; 2022 Elon All Rights Reserved</small>
<small class=ml-1><a href=https://policies.google.com/privacy target=_blank rel=noopener>隐私政策</a></small>
</div>
</div>
</div>
</footer>
</div>
<script src=https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js integrity=sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN crossorigin=anonymous></script>
<script src=https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/js/bootstrap.min.js integrity=sha384-+YQ4JLhjyBLPDQt//I+STsc9iw4uQqACwlvpslubQzn4u2UU2UFM80nGisd026JF crossorigin=anonymous></script>
<script src=/js/main.min.3b172c13b62c2bea8b1c9d2599cddc8cf89718a92d792c680871c81ba43d8c85.js integrity="sha256-OxcsE7YsK+qLHJ0lmc3cjPiXGKkteSxoCHHIG6Q9jIU=" crossorigin=anonymous></script>
</body>
</html>